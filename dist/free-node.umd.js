!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).FreeNode={})}(this,function(e){"use strict";var t=Object.defineProperty,o=(e,o,s)=>((e,o,s)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[o]=s)(e,"symbol"!=typeof o?o+"":o,s);class s{constructor(){this.types=new Map}register(e,t){if(!e||"string"!=typeof e)throw new Error("Invalid node type: type must be a non-empty string, got "+typeof e);if(!t||"object"!=typeof t)throw new Error(`Invalid definition for type "${e}": definition must be an object`);if(this.types.has(e))throw new Error(`Node type "${e}" is already registered. Use unregister() first to replace it.`);this.types.set(e,t)}unregister(e){if(!this.types.has(e))throw new Error(`Cannot unregister type "${e}": type is not registered`);this.types.delete(e)}removeAll(){this.types.clear()}createInstance(e){const t=this.types.get(e);if(!t){const t=Array.from(this.types.keys()).join(", ")||"none";throw new Error(`Unknown node type: "${e}". Available types: ${t}`)}return t}}function n(){const e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},t=e.crypto||e.msCrypto;if(t&&"function"==typeof t.randomUUID)return t.randomUUID();if(t&&"function"==typeof t.getRandomValues){const e=new Uint8Array(16);t.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const o=Array.from(e,e=>e.toString(16).padStart(2,"0"));return o.slice(0,4).join("")+"-"+o.slice(4,6).join("")+"-"+o.slice(6,8).join("")+"-"+o.slice(8,10).join("")+"-"+o.slice(10,16).join("")}try{const e=Function('return typeof require === "function" ? require : null')();if(e){const t=e("crypto");if("function"==typeof t.randomUUID)return t.randomUUID();const o=t.randomBytes(16);o[6]=15&o[6]|64,o[8]=63&o[8]|128;const s=Array.from(o,e=>e.toString(16).padStart(2,"0"));return s.slice(0,4).join("")+"-"+s.slice(4,6).join("")+"-"+s.slice(6,8).join("")+"-"+s.slice(8,10).join("")+"-"+s.slice(10,16).join("")}}catch{}const o=new Uint8Array(16);for(let n=0;n<16;n++)o[n]=Math.floor(256*Math.random());o[6]=15&o[6]|64,o[8]=63&o[8]|128;const s=Array.from(o,e=>e.toString(16).padStart(2,"0"));return s.slice(0,4).join("")+"-"+s.slice(4,6).join("")+"-"+s.slice(6,8).join("")+"-"+s.slice(8,10).join("")+"-"+s.slice(10,16).join("")}class r{constructor({id:e,type:t,title:o,x:s=0,y:r=0,width:i=160,height:a=60}){if(!t)throw new Error("Node type is required");this.id=e??n(),this.type=t,this.title=o??t,this.pos={x:s,y:r},this.size={width:i,height:a},this.inputs=[],this.outputs=[],this.state={},this.parent=null,this.children=new Set,this.computed={x:0,y:0,w:0,h:0}}addInput(e,t="any"){if(!e||"string"!=typeof e)throw new Error("Input port name must be a non-empty string");const o={id:n(),name:e,datatype:t,dir:"in"};return this.inputs.push(o),o}addOutput(e,t="any"){if(!e||"string"!=typeof e)throw new Error("Output port name must be a non-empty string");const o={id:n(),name:e,datatype:t,dir:"out"};return this.outputs.push(o),o}}class i{constructor({id:e,fromNode:t,fromPort:o,toNode:s,toPort:r}){if(!(t&&o&&s&&r))throw new Error("Edge requires fromNode, fromPort, toNode, and toPort");this.id=e??n(),this.fromNode=t,this.fromPort=o,this.toNode=s,this.toPort=r}}class a{constructor({graph:e,hooks:t}){this.graph=e,this.hooks=t}addGroup({title:e="Group",x:t=0,y:o=0,width:s=240,height:n=160,color:r="#39424e",members:i=[]}={}){var a;(s<100||n<60)&&(console.warn("Group size too small, using minimum size"),s=Math.max(100,s),n=Math.max(60,n));const d=this.graph.addNode("core/Group",{title:e,x:t,y:o,width:s,height:n});d.state.color=r;for(const h of i){const e=this.graph.getNodeById(h);if(e){if("core/Group"===e.type){console.warn(`Cannot add group ${h} as member of another group`);continue}this.graph.reparent(e,d)}else console.warn(`Member node ${h} not found, skipping`)}return null==(a=this.hooks)||a.emit("group:change"),d}addGroupFromSelection({title:e="Group",margin:t={x:12,y:12}}={}){return null}removeGroup(e){var t;const o=this.graph.getNodeById(e);if(!o||"core/Group"!==o.type)return;const s=[...o.children];for(const n of s)this.graph.reparent(n,o.parent);this.graph.removeNode(e),null==(t=this.hooks)||t.emit("group:change")}resizeGroup(e,t,o){var s;const n=this.graph.getNodeById(e);if(!n||"core/Group"!==n.type)return;n.size.width=Math.max(100,n.size.width+t),n.size.height=Math.max(60,n.size.height+o),this.graph.updateWorldTransforms(),null==(s=this.hooks)||s.emit("group:change")}hitTestResizeHandle(e,t){const o=[...this.graph.nodes.values()].reverse();for(const s of o){if("core/Group"!==s.type)continue;const{x:o,y:n,w:r,h:i}=s.computed;if(e>=o+r-10&&e<=o+r&&t>=n+i-10&&t<=n+i)return{group:s,handle:"se"}}return null}}class d{constructor({hooks:e,registry:t}){if(!t)throw new Error("Graph requires a registry");this.nodes=new Map,this.edges=new Map,this.hooks=e,this.registry=t,this._valuesA=new Map,this._valuesB=new Map,this._useAasCurrent=!0,this.groupManager=new a({graph:this,hooks:this.hooks})}getNodeById(e){return this.nodes.get(e)||null}addNode(e,t={}){var o,s,n,i;const a=this.registry.types.get(e);if(!a){const t=Array.from(this.registry.types.keys()).join(", ")||"none";throw new Error(`Unknown node type: "${e}". Available types: ${t}`)}const d=new r({type:e,title:a.title,width:null==(o=a.size)?void 0:o.w,height:null==(s=a.size)?void 0:s.h,...t});for(const r of a.inputs||[])d.addInput(r.name,r.datatype);for(const r of a.outputs||[])d.addOutput(r.name,r.datatype);return null==(n=a.onCreate)||n.call(a,d),this.nodes.set(d.id,d),null==(i=this.hooks)||i.emit("node:create",d),d}removeNode(e){for(const[t,o]of this.edges)o.fromNode!==e&&o.toNode!==e||this.edges.delete(t);this.nodes.delete(e)}addEdge(e,t,o,s){var n;if(!this.nodes.has(e))throw new Error(`Cannot create edge: source node "${e}" not found`);if(!this.nodes.has(o))throw new Error(`Cannot create edge: target node "${o}" not found`);const r=new i({fromNode:e,fromPort:t,toNode:o,toPort:s});return this.edges.set(r.id,r),null==(n=this.hooks)||n.emit("edge:create",r),r}clear(){this.nodes.clear(),this.edges.clear()}updateWorldTransforms(){const e=[];for(const o of this.nodes.values())o.parent||e.push(o);const t=e.map(e=>({node:e,px:0,py:0}));for(;t.length>0;){const{node:e,px:o,py:s}=t.pop();e.computed.x=o+e.pos.x,e.computed.y=s+e.pos.y,e.computed.w=e.size.width,e.computed.h=e.size.height;for(const n of e.children)t.push({node:n,px:e.computed.x,py:e.computed.y})}}reparent(e,t){if(e.parent===t)return;const o=e.computed.x,s=e.computed.y;e.parent&&e.parent.children.delete(e),e.parent=t,t?(t.children.add(e),e.pos.x=o-t.computed.x,e.pos.y=s-t.computed.y):(e.pos.x=o,e.pos.y=s),this.updateWorldTransforms()}_curBuf(){return this._useAasCurrent?this._valuesA:this._valuesB}_nextBuf(){return this._useAasCurrent?this._valuesB:this._valuesA}swapBuffers(){this._useAasCurrent=!this._useAasCurrent,this._nextBuf().clear()}setOutput(e,t,o){this._nextBuf().set(`${e}:${t}`,o)}getInput(e,t){for(const o of this.edges.values())if(o.toNode===e&&o.toPort===t)return this._curBuf().get(`${o.fromNode}:${o.fromPort}`)}toJSON(){var e;const t={nodes:[...this.nodes.values()].map(e=>({id:e.id,type:e.type,title:e.title,x:e.pos.x,y:e.pos.y,w:e.size.width,h:e.size.height,inputs:e.inputs,outputs:e.outputs,state:e.state})),edges:[...this.edges.values()]};return null==(e=this.hooks)||e.emit("graph:serialize",t),t}fromJSON(e){this.clear();for(const t of e.nodes){const e=new r({id:t.id,type:t.type,title:t.title,x:t.x,y:t.y,width:t.w,height:t.h});e.inputs=t.inputs,e.outputs=t.outputs,e.state=t.state||{},this.nodes.set(e.id,e)}for(const t of e.edges)this.edges.set(t.id,new i(t));return this}}function h(e,t,o,s){const{x:n,y:r,w:i}=e.computed||{x:e.pos.x,y:e.pos.y,w:e.size.width},a=r+28+20*o;return"in"===s?{x:n-8,y:a,w:8,h:14}:"out"===s?{x:n+i,y:a,w:8,h:14}:void 0}const l=class e{constructor(e,{theme:t={},registry:o,edgeStyle:s="orthogonal"}={}){this.canvas=e,this.ctx=e.getContext("2d"),this.registry=o,this.scale=1,this.minScale=.25,this.maxScale=3,this.offsetX=0,this.offsetY=0,this.edgeStyle=s,this.theme=Object.assign({bg:"#141417",grid:"#25252a",node:"#1e1e24",title:"#2a2a31",text:"#e9e9ef",port:"#8aa1ff",edge:"#7f8cff"},t)}setEdgeStyle(e){this.edgeStyle="line"===e||"orthogonal"===e?e:"bezier"}setRegistry(e){this.registry=e}resize(e,t){this.canvas.width=e,this.canvas.height=t}setTransform({scale:e=this.scale,offsetX:t=this.offsetX,offsetY:o=this.offsetY}={}){this.scale=Math.min(this.maxScale,Math.max(this.minScale,e)),this.offsetX=t,this.offsetY=o}panBy(e,t){this.offsetX+=e,this.offsetY+=t}zoomAt(e,t,o){const s=this.scale,n=Math.min(this.maxScale,Math.max(this.minScale,s*e));if(n===s)return;const r=(t-this.offsetX)/s,i=(o-this.offsetY)/s;this.offsetX=t-r*n,this.offsetY=o-i*n,this.scale=n}screenToWorld(e,t){return{x:(e-this.offsetX)/this.scale,y:(t-this.offsetY)/this.scale}}worldToScreen(e,t){return{x:e*this.scale+this.offsetX,y:t*this.scale+this.offsetY}}_applyTransform(){const{ctx:e}=this;e.setTransform(this.scale,0,0,this.scale,this.offsetX,this.offsetY)}_resetTransform(){this.ctx.setTransform(1,0,0,1,0,0)}_drawArrowhead(e,t,o,s,n=10){const{ctx:r}=this,i=n/this.scale,a=Math.atan2(s-t,o-e);r.beginPath(),r.moveTo(o,s),r.lineTo(o-i*Math.cos(a-Math.PI/6),s-i*Math.sin(a-Math.PI/6)),r.lineTo(o-i*Math.cos(a+Math.PI/6),s-i*Math.sin(a+Math.PI/6)),r.closePath(),r.fill()}_drawScreenText(e,t,o,{fontPx:s=12,color:n=this.theme.text,align:r="left",baseline:i="alphabetic",dpr:a=1}={}){const{ctx:d}=this,{x:h,y:l}=this.worldToScreen(t,o);d.save(),this._resetTransform();const c=Math.round(h)+.5,u=Math.round(l)+.5;d.font=s*this.scale+"px system-ui",d.fillStyle=n,d.textAlign=r,d.textBaseline=i,d.fillText(e,c,u),d.restore()}drawGrid(){const{ctx:e,canvas:t,theme:o,scale:s,offsetX:n,offsetY:r}=this;this._resetTransform(),e.fillStyle=o.bg,e.fillRect(0,0,t.width,t.height),this._applyTransform(),e.strokeStyle=o.grid,e.lineWidth=1/s;const i=20,a=-n/s,d=-r/s,h=(t.width-n)/s,l=(t.height-r)/s,c=Math.floor(a/i)*i,u=Math.floor(d/i)*i;e.beginPath();for(let p=c;p<=h;p+=i)e.moveTo(p,d),e.lineTo(p,l);for(let p=u;p<=l;p+=i)e.moveTo(a,p),e.lineTo(h,p);e.stroke(),this._resetTransform()}draw(t,{selection:o=new Set,tempEdge:s=null,running:n=!1,time:r=performance.now(),dt:i=0,groups:a=null}={}){var d,h,l,c;t.updateWorldTransforms(),this.drawGrid();const{ctx:u,theme:p}=this;if(this._applyTransform(),u.save(),n){const t=r/1e3*120/this.scale%e.FONT_SIZE;u.setLineDash([6/this.scale,6/this.scale]),u.lineDashOffset=-t}else u.setLineDash([]),u.lineDashOffset=0;for(const e of t.nodes.values())if("core/Group"===e.type){const t=o.has(e.id),s=null==(h=null==(d=this.registry)?void 0:d.types)?void 0:h.get(e.type);(null==s?void 0:s.onDraw)?s.onDraw(e,{ctx:u,theme:p}):this._drawNode(e,t)}u.strokeStyle=p.edge,u.lineWidth=2*this.scale;for(const e of t.edges.values())this._drawEdge(t,e);if(s){const e=this.screenToWorld(s.x1,s.y1),t=this.screenToWorld(s.x2,s.y2),o=this.ctx.getLineDash();this.ctx.setLineDash([6/this.scale,6/this.scale]);let n=null;if("line"===this.edgeStyle?(this._drawLine(e.x,e.y,t.x,t.y),n=[{x:e.x,y:e.y},{x:t.x,y:t.y}]):"orthogonal"===this.edgeStyle?n=this._drawOrthogonal(e.x,e.y,t.x,t.y):(this._drawCurve(e.x,e.y,t.x,t.y),n=[{x:e.x,y:e.y},{x:t.x,y:t.y}]),this.ctx.setLineDash(o),n&&n.length>=2){const e=n[n.length-2],t=n[n.length-1];this.ctx.fillStyle=this.theme.edge,this.ctx.strokeStyle=this.theme.edge,this._drawArrowhead(e.x,e.y,t.x,t.y,12)}}u.restore();for(const e of t.nodes.values())if("core/Group"!==e.type){const t=o.has(e.id);this._drawNode(e,t);const s=null==(c=null==(l=this.registry)?void 0:l.types)?void 0:c.get(e.type);(null==s?void 0:s.onDraw)&&s.onDraw(e,{ctx:u,theme:p})}this._resetTransform()}_rgba(e,t){const o=e.replace("#",""),s=parseInt(3===o.length?o.split("").map(e=>e+e).join(""):o,16);return`rgba(${s>>16&255},${s>>8&255},${255&s},${t})`}_drawNode(t,o){const{ctx:s,theme:n}=this,{x:r,y:i,w:a,h:d}=t.computed;s.fillStyle=n.node,s.strokeStyle=o?"#6cf":"#333",s.lineWidth=(o?2:1.2)/this.scale,u(s,r,i,a,d,8),s.fill(),s.stroke(),s.fillStyle=n.title,u(s,r,i,a,24,{tl:8,tr:8,br:0,bl:0}),s.fill(),this._drawScreenText(t.title,r+8,i+e.FONT_SIZE,{fontPx:e.FONT_SIZE,color:n.text,baseline:"middle",align:"left"}),s.fillStyle=n.port,t.inputs.forEach((e,o)=>{const n=h(t,0,o,"in");s.fillRect(n.x,n.y,n.w,n.h)}),t.outputs.forEach((e,o)=>{const n=h(t,0,o,"out");s.fillRect(n.x,n.y,n.w,n.h)})}_drawEdge(e,t){const o=e.nodes.get(t.fromNode),s=e.nodes.get(t.toNode);if(!o||!s)return;const n=o.outputs.findIndex(e=>e.id===t.fromPort),r=s.inputs.findIndex(e=>e.id===t.toPort),i=h(o,0,n,"out"),a=h(s,0,r,"in"),d=i.x,l=i.y+7,c=a.x,u=a.y+7;"line"===this.edgeStyle?this._drawLine(d,l,c,u):"orthogonal"===this.edgeStyle?this._drawOrthogonal(d,l,c,u):this._drawCurve(d,l,c,u)}_drawLine(e,t,o,s){const{ctx:n}=this;n.beginPath(),n.moveTo(e,t),n.lineTo(o,s),n.stroke()}_drawPolyline(e){const{ctx:t}=this;t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let o=1;o<e.length;o++)t.lineTo(e[o].x,e[o].y);t.stroke()}_drawOrthogonal(e,t,o,s){const n=(e+o)/2;let r;r=[{x:e,y:t},{x:n,y:t},{x:n,y:s},{x:o,y:s}];const{ctx:i}=this,a=i.lineJoin,d=i.lineCap;return i.lineJoin="round",i.lineCap="round",this._drawPolyline(r),i.lineJoin=a,i.lineCap=d,r}_drawCurve(e,t,o,s){const{ctx:n}=this,r=Math.max(40,.4*Math.abs(o-e));n.beginPath(),n.moveTo(e,t),n.bezierCurveTo(e+r,t,o-r,s,o,s),n.stroke()}};o(l,"FONT_SIZE",12);let c=l;function u(e,t,o,s,n,r=6){"number"==typeof r&&(r={tl:r,tr:r,br:r,bl:r}),e.beginPath(),e.moveTo(t+r.tl,o),e.lineTo(t+s-r.tr,o),e.quadraticCurveTo(t+s,o,t+s,o+r.tr),e.lineTo(t+s,o+n-r.br),e.quadraticCurveTo(t+s,o+n,t+s-r.br,o+n),e.lineTo(t+r.bl,o+n),e.quadraticCurveTo(t,o+n,t,o+n-r.bl),e.lineTo(t,o+r.tl),e.quadraticCurveTo(t,o,t+r.tl,o),e.closePath()}function p(e,t,o,s,n){for(const[r,i]of e.edges)if(i.fromNode===t&&i.fromPort===o&&i.toNode===s&&i.toPort===n)return r;return null}class f{constructor(){this.undoStack=[],this.redoStack=[]}exec(e){e.do(),this.undoStack.push(e),this.redoStack.length=0}undo(){const e=this.undoStack.pop();e&&(e.undo(),this.redoStack.push(e))}redo(){const e=this.redoStack.pop();e&&(e.do(),this.undoStack.push(e))}}const g=class e{constructor({graph:e,renderer:t,hooks:o,htmlOverlay:s}){this.graph=e,this.renderer=t,this.hooks=o,this.htmlOverlay=s,this.stack=new f,this.selection=new Set,this.dragging=null,this.connecting=null,this.panning=null,this.resizing=null,this.gDragging=null,this.gResizing=null,this._cursor="default",this._onKeyPressEvt=this._onKeyPress.bind(this),this._onDownEvt=this._onDown.bind(this),this._onWheelEvt=this._onWheel.bind(this),this._onMoveEvt=this._onMove.bind(this),this._onUpEvt=this._onUp.bind(this),this._bindEvents()}destructor(){const e=this.renderer.canvas;e.removeEventListener("mousedown",this._onDownEvt),e.removeEventListener("wheel",this._onWheelEvt,{passive:!1}),window.removeEventListener("mousemove",this._onMoveEvt),window.removeEventListener("mouseup",this._onUpEvt),window.removeEventListener("keydown",this._onKeyPressEvt)}_bindEvents(){const e=this.renderer.canvas;e.addEventListener("mousedown",this._onDownEvt),e.addEventListener("wheel",this._onWheelEvt,{passive:!1}),window.addEventListener("mousemove",this._onMoveEvt),window.addEventListener("mouseup",this._onUpEvt),window.addEventListener("keydown",this._onKeyPressEvt)}_onKeyPress(e){return(e.ctrlKey||e.metaKey)&&"z"===e.key.toLowerCase()?(e.preventDefault(),e.shiftKey?this.stack.redo():this.stack.undo(),void this.render()):(e.ctrlKey||e.metaKey)&&"y"===e.key.toLowerCase()?(e.preventDefault(),this.stack.redo(),void this.render()):void("Delete"===e.key&&([...this.selection].forEach(e=>{const t=this.graph.getNodeById(e);this.stack.exec(function(e,t){let o=null,s=[];return{do(){o=t,s=e.edges?[...e.edges.values()].filter(e=>(console.log(e),e.fromNode===t.id||e.toNode===t.id)):[];for(const t of s)e.edges.delete(t.id);e.nodes.delete(t.id)},undo(){o&&e.nodes.set(o.id,o);for(const t of s)e.edges.set(t.id,t)}}}(this.graph,t)),this.graph.removeNode(e)}),this.render()))}_setCursor(e){this._cursor!==e&&(this._cursor=e,this.renderer.canvas.style.cursor=e)}_posScreen(e){const t=this.renderer.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}_posWorld(e){const t=this._posScreen(e);return this.renderer.screenToWorld(t.x,t.y)}_findNodeAtWorld(e,t){const o=[...this.graph.nodes.values()].reverse();for(const s of o){const{x:o,y:n,w:r,h:i}=s.computed;if(e>=o&&e<=o+r&&t>=n&&t<=n+i)return s}return null}_findPortAtWorld(e,t){for(const o of this.graph.nodes.values()){for(let s=0;s<o.inputs.length;s++){if(m(h(o,o.inputs[s],s,"in"),e,t))return{node:o,port:o.inputs[s],dir:"in",idx:s}}for(let s=0;s<o.outputs.length;s++){if(m(h(o,o.outputs[s],s,"out"),e,t))return{node:o,port:o.outputs[s],dir:"out",idx:s}}}return null}_findIncomingEdge(e,t){for(const[o,s]of this.graph.edges)if(s.toNode===e&&s.toPort===t)return{id:o,edge:s};return null}_onWheel(e){e.preventDefault();const{x:t,y:o}=this._posScreen(e),s=Math.pow(1.0015,-e.deltaY);this.renderer.zoomAt(s,t,o),this.render()}_resizeHandleRect(e){const{x:t,y:o,w:s,h:n}=e.computed;return{x:t+s-10,y:o+n-10,w:10,h:10}}_hitResizeHandle(e,t,o){const s=this._resizeHandleRect(e);return t>=s.x&&t<=s.x+s.w&&o>=s.y&&o<=s.y+s.h}_onDown(e){const t=this._posScreen(e),o=this._posWorld(e);if(1===e.button)return void(this.panning={x:t.x,y:t.y});const s=this._findNodeAtWorld(o.x,o.y);if(0===e.button&&s&&this._hitResizeHandle(s,o.x,o.y))return this.resizing={nodeId:s.id,startW:s.size.width,startH:s.size.height,startX:o.x,startY:o.y},e.shiftKey||this.selection.clear(),this.selection.add(s.id),this._setCursor("se-resize"),void this.render();const n=this._findPortAtWorld(o.x,o.y);if(0===e.button&&n&&"out"===n.dir){const e=h(n.node,n.port,n.idx,"out"),t=this.renderer.worldToScreen(e.x,e.y+7);return void(this.connecting={fromNode:n.node.id,fromPort:n.port.id,x:t.x,y:t.y})}return 0===e.button&&s?(e.shiftKey||this.selection.clear(),this.selection.add(s.id),this.dragging={nodeId:s.id,offsetX:o.x-s.computed.x,offsetY:o.y-s.computed.y,startPos:{...s.pos}},void this.render()):0===e.button?(this.selection.size&&this.selection.clear(),this.panning={x:t.x,y:t.y},void this.render()):void 0}_onMove(t){var o,s;const n=this._posScreen(t),r=this.renderer.screenToWorld(n.x,n.y);if(this.resizing){const t=this.graph.nodes.get(this.resizing.nodeId),s=r.x-this.resizing.startX,n=r.y-this.resizing.startY,i=e.MIN_NODE_WIDTH,a=e.MIN_NODE_HEIGHT;return t.size.width=Math.max(i,this.resizing.startW+s),t.size.height=Math.max(a,this.resizing.startH+n),null==(o=this.hooks)||o.emit("node:resize",t),this._setCursor("se-resize"),void this.render()}if(this.panning){const e=n.x-this.panning.x,t=n.y-this.panning.y;return this.panning={x:n.x,y:n.y},this.renderer.panBy(e,t),void this.render()}if(this.dragging){const e=this.graph.nodes.get(this.dragging.nodeId),t=r.x-this.dragging.offsetX,o=r.y-this.dragging.offsetY;let n=0,i=0;return e.parent&&(n=e.parent.computed.x,i=e.parent.computed.y),e.pos.x=t-n,e.pos.y=o-i,null==(s=this.hooks)||s.emit("node:move",e),void this.render()}this.connecting&&(this.connecting.x=n.x,this.connecting.y=n.y,this.render());const i=this._findNodeAtWorld(r.x,r.y);i&&this._hitResizeHandle(i,r.x,r.y)?this._setCursor("se-resize"):this._setCursor("default")}_onUp(e){const t=this._posWorld(e);if(this.panning)this.panning=null;else{if(this.connecting){const e=this.connecting,o=this._findPortAtWorld(t.x,t.y);o&&"in"===o.dir&&this.stack.exec(function(e,t,o,s,n){let r=null;return{do(){e.addEdge(t,o,s,n),r=p(e,t,o,s,n)},undo(){const i=r??p(e,t,o,s,n);null!=i&&e.edges.delete(i)}}}(this.graph,e.fromNode,e.fromPort,o.node.id,o.port.id)),this.connecting=null,this.render()}if(this.resizing){const e=this.graph.nodes.get(this.resizing.nodeId),t={w:this.resizing.startW,h:this.resizing.startH},r={w:e.size.width,h:e.size.height};t.w===r.w&&t.h===r.h||this.stack.exec((o=e,s=t,n=r,{do(){o.size.width=n.w,o.size.height=n.h},undo(){o.size.width=s.w,o.size.height=s.h}})),this.resizing=null,this._setCursor("default")}var o,s,n;if(this.dragging){const e=this.graph.nodes.get(this.dragging.nodeId),o=this._findPotentialParent(t.x,t.y,e);o&&o!==e.parent?this.graph.reparent(e,o):!o&&e.parent&&this.graph.reparent(e,null),this.dragging=null,this.render()}}}_findPotentialParent(e,t,o){const s=[...this.graph.nodes.values()].reverse();for(const n of s){if("core/Group"!==n.type)continue;if(n===o)continue;let s=n.parent,r=!1;for(;s;){if(s===o){r=!0;break}s=s.parent}if(r)continue;const{x:i,y:a,w:d,h:h}=n.computed;if(e>=i&&e<=i+d&&t>=a&&t<=a+h)return n}return null}render(){var e;const t=this.renderTempEdge();this.renderer.draw(this.graph,{selection:this.selection,tempEdge:t}),null==(e=this.htmlOverlay)||e.draw(this.graph,this.selection)}renderTempEdge(){if(!this.connecting)return null;const e=this._portAnchorScreen(this.connecting.fromNode,this.connecting.fromPort);return{x1:e.x,y1:e.y,x2:this.connecting.x,y2:this.connecting.y}}_portAnchorScreen(e,t){const o=this.graph.nodes.get(e),s=o.outputs.findIndex(e=>e.id===t),n=h(o,0,s,"out");return this.renderer.worldToScreen(n.x,n.y+7)}};o(g,"MIN_NODE_WIDTH",80),o(g,"MIN_NODE_HEIGHT",60);let y=g;function m(e,t,o){return t>=e.x&&t<=e.x+e.w&&o>=e.y&&o<=e.y+e.h}class x{constructor({graph:e,registry:t,hooks:o,cyclesPerFrame:s=1}){this.graph=e,this.registry=t,this.hooks=o,this.running=!1,this._raf=null,this._last=0,this.cyclesPerFrame=Math.max(1,0|s)}isRunning(){return this.running}setCyclesPerFrame(e){this.cyclesPerFrame=Math.max(1,0|e)}step(e=1,t=0){var o,s;const n=Math.max(1,0|e);for(let i=0;i<n;i++){for(const e of this.graph.nodes.values()){const n=this.registry.types.get(e.type);if(null==n?void 0:n.onExecute)try{n.onExecute(e,{dt:t,graph:this.graph,getInput:t=>{const o=e.inputs.find(e=>e.name===t)||e.inputs[0];return o?this.graph.getInput(e.id,o.id):void 0},setOutput:(t,o)=>{const s=e.outputs.find(e=>e.name===t)||e.outputs[0];s&&this.graph.setOutput(e.id,s.id,o)}})}catch(r){null==(s=null==(o=this.hooks)?void 0:o.emit)||s.call(o,"error",r)}}this.graph.swapBuffers()}}start(){var e,t;if(this.running)return;this.running=!0,this._last=0,null==(t=null==(e=this.hooks)?void 0:e.emit)||t.call(e,"runner:start");const o=e=>{var t,s;if(!this.running)return;const n=this._last?e-this._last:0;this._last=e;const r=n/1e3;this.step(this.cyclesPerFrame,r),null==(s=null==(t=this.hooks)?void 0:t.emit)||s.call(t,"runner:tick",{time:e,dt:r,running:!0,cps:this.cyclesPerFrame}),this._raf=requestAnimationFrame(o)};this._raf=requestAnimationFrame(o)}stop(){var e,t;this.running&&(this.running=!1,this._raf&&cancelAnimationFrame(this._raf),this._raf=null,this._last=0,null==(t=null==(e=this.hooks)?void 0:e.emit)||t.call(e,"runner:stop"))}}class w{constructor(e,t,o){this.host=e,this.renderer=t,this.registry=o,this.container=document.createElement("div"),Object.assign(this.container.style,{position:"absolute",inset:"0",pointerEvents:"none",zIndex:"10"}),e.appendChild(this.container),this.nodes=new Map}_createDefaultNodeLayout(e){const t=document.createElement("div");Object.assign(t.style,{position:"absolute",display:"flex",flexDirection:"column",boxSizing:"border-box",pointerEvents:"none",overflow:"hidden"});const o=document.createElement("div");o.className="node-header",Object.assign(o.style,{height:"24px",flexShrink:"0",display:"flex",alignItems:"center",padding:"0 8px",cursor:"grab",userSelect:"none",pointerEvents:"none"});const s=document.createElement("div");return s.className="node-body",Object.assign(s.style,{flex:"1",position:"relative",overflow:"hidden",pointerEvents:"auto",pointerEvents:"none"}),t.appendChild(o),t.appendChild(s),t._domParts={header:o,body:s},t}_ensureNodeElement(e,t){var o;let s=this.nodes.get(e.id);if(!s){if(null==(o=t.html)?void 0:o.render)s=t.html.render(e);else{if(!t.html)return null;s=this._createDefaultNodeLayout(e),t.html.init&&t.html.init(e,s,s._domParts)}if(!s)return null;s.style.position="absolute",s.style.pointerEvents="none",this.container.appendChild(s),this.nodes.set(e.id,s)}return s}draw(e,t=new Set){const{scale:o,offsetX:s,offsetY:n}=this.renderer;this.container.style.transform=`translate(${s}px, ${n}px) scale(${o})`,this.container.style.transformOrigin="0 0";const r=new Set;for(const i of e.nodes.values()){const e=this.registry.types.get(i.type);if(!!!(null==e?void 0:e.html))continue;const o=this._ensureNodeElement(i,e);if(o){if(console.log(i),o.style.left=`${i.computed.x}px`,o.style.top=`${i.computed.y}px`,o.style.width=`${i.computed.w}px`,o.style.height=`${i.computed.h}px`,e.html.update){const s=o._domParts||{};e.html.update(i,o,{selected:t.has(i.id),header:s.header,body:s.body})}r.add(i.id)}}for(const[i,a]of this.nodes)r.has(i)||(a.remove(),this.nodes.delete(i))}destroy(){for(const[,e]of this.nodes)e.remove();this.nodes.clear(),this.container.remove()}}e.createGraphEditor=function(e,{theme:t,hooks:o,autorun:n=!0}={}){const r=o??function(e){const t=Object.fromEntries(e.map(e=>[e,new Set]));return{on:(e,o)=>(t[e].add(o),()=>t[e].delete(o)),async emit(e,...o){for(const s of t[e])await s(...o)}}}(["node:create","node:move","edge:create","edge:delete","graph:serialize","error","runner:tick","runner:start","runner:stop","node:resize","group:change","node:updated"]),i=new s,a=new d({hooks:r,registry:i}),h=new c(e,{theme:t,registry:i}),l=new w(e.parentElement,h,i),u=new y({graph:a,renderer:h,hooks:r,htmlOverlay:l}),p=new x({graph:a,registry:i,hooks:r});r.on("runner:tick",({time:e,dt:t})=>{h.draw(a,{selection:u.selection,tempEdge:u.connecting?u.renderTempEdge():null,running:!0,time:e,dt:t}),l.draw(a,u.selection)}),r.on("runner:start",()=>{h.draw(a,{selection:u.selection,tempEdge:u.connecting?u.renderTempEdge():null,running:!0,time:performance.now(),dt:0}),l.draw(a,u.selection)}),r.on("runner:stop",()=>{h.draw(a,{selection:u.selection,tempEdge:u.connecting?u.renderTempEdge():null,running:!1,time:performance.now(),dt:0}),l.draw(a,u.selection)}),r.on("node:updated",()=>{u.render()}),i.register("core/Note",{title:"Note",size:{w:180,h:80},inputs:[{name:"in",datatype:"any"}],outputs:[{name:"out",datatype:"any"}],onCreate(e){e.state.text="hello"},onExecute(e,{dt:t,getInput:o,setOutput:s}){s("out",(o("in")??e.state.text??"").toString().toUpperCase()+` · ${Math.floor(performance.now()/1e3%100)}`)},onDraw(e,{ctx:t,theme:o}){const{x:s,y:n}=e.pos,{width:r}=e.size}}),i.register("core/HtmlNote",{title:"HTML Note",size:{w:200,h:150},inputs:[{name:"in",datatype:"any"}],outputs:[{name:"out",datatype:"any"}],html:{init(e,t,{header:o,body:s}){t.style.backgroundColor="#222",t.style.borderRadius="8px",t.style.border="1px solid #444",t.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)",o.style.backgroundColor="#333",o.style.borderBottom="1px solid #444",o.style.color="#eee",o.style.fontSize="12px",o.style.fontWeight="bold",o.textContent="My HTML Node",s.style.padding="8px",s.style.color="#ccc",s.style.fontSize="12px";const n=document.createElement("div");n.textContent="Content: -- 인션이",s.appendChild(n);const r=document.createElement("input");Object.assign(r.style,{marginTop:"4px",padding:"4px",background:"#111",border:"1px solid #555",color:"#fff",borderRadius:"4px",pointerEvents:"auto"}),r.placeholder="Type here...",r.addEventListener("input",t=>{e.state.text=t.target.value}),r.addEventListener("mousedown",e=>e.stopPropagation()),s.appendChild(document.createTextNode("Content:")),s.appendChild(r),t._input=r},update(e,t,{header:o,body:s,selected:n}){t.style.borderColor=n?"#6cf":"#444",o.style.backgroundColor=n?"#3a4a5a":"#333",t._input.value!==(e.state.text||"")&&(t._input.value=e.state.text||"")}},onCreate(e){e.state.text=""},onExecute(e,{getInput:t,setOutput:o}){o("out",t("in"))}}),i.register("core/TodoNode",{title:"Todo List",size:{w:240,h:300},inputs:[{name:"in",datatype:"any"}],outputs:[{name:"out",datatype:"any"}],html:{init(e,t,{header:o,body:s}){t.style.backgroundColor="#1e1e24",t.style.borderRadius="8px",t.style.boxShadow="0 4px 12px rgba(0,0,0,0.5)",t.style.border="1px solid #333",o.style.backgroundColor="#2a2a31",o.style.padding="8px",o.style.fontWeight="bold",o.style.color="#e9e9ef",o.textContent=e.title,s.style.display="flex",s.style.flexDirection="column",s.style.padding="8px",s.style.color="#e9e9ef";const n=document.createElement("div");Object.assign(n.style,{display:"flex",gap:"4px",marginBottom:"8px"});const i=document.createElement("input");Object.assign(i.style,{flex:"1",padding:"6px",borderRadius:"4px",border:"1px solid #444",background:"#141417",color:"#fff",pointerEvents:"auto"}),i.placeholder="Add task...";const a=document.createElement("button");a.textContent="+",Object.assign(a.style,{padding:"0 12px",cursor:"pointer",background:"#4f5b66",color:"#fff",border:"none",borderRadius:"4px",pointerEvents:"auto"}),n.append(i,a);const d=document.createElement("ul");Object.assign(d.style,{listStyle:"none",padding:"0",margin:"0",overflowY:"auto",flex:"1"}),s.append(n,d);const h=()=>{const t=i.value.trim();if(!t)return;const o=e.state.todos||[];e.state.todos=[...o,{id:Date.now(),text:t,done:!1}],i.value="",r.emit("node:updated",e)};a.onclick=h,i.onkeydown=e=>{"Enter"===e.key&&h(),e.stopPropagation()},i.onmousedown=e=>e.stopPropagation(),t._refs={list:d}},update(e,t,{selected:o}){t.style.borderColor=o?"#6cf":"#333";const{list:s}=t._refs,n=e.state.todos||[];s.innerHTML="",n.forEach(t=>{const o=document.createElement("li");Object.assign(o.style,{display:"flex",alignItems:"center",padding:"6px 0",borderBottom:"1px solid #2a2a31"});const n=document.createElement("input");n.type="checkbox",n.checked=t.done,n.style.marginRight="8px",n.style.pointerEvents="auto",n.onchange=()=>{t.done=n.checked,r.emit("node:updated",e)},n.onmousedown=e=>e.stopPropagation();const i=document.createElement("span");i.textContent=t.text,i.style.flex="1",i.style.textDecoration=t.done?"line-through":"none",i.style.color=t.done?"#777":"#eee";const a=document.createElement("button");a.textContent="×",Object.assign(a.style,{background:"none",border:"none",color:"#f44",cursor:"pointer",fontSize:"16px",pointerEvents:"auto"}),a.onclick=()=>{e.state.todos=e.state.todos.filter(e=>e.id!==t.id),r.emit("node:updated",e)},a.onmousedown=e=>e.stopPropagation(),o.append(n,i,a),s.appendChild(o)})}},onCreate(e){e.state.todos=[{id:1,text:"Welcome to Free Node",done:!1},{id:2,text:"Try adding a task",done:!0}]}}),i.register("core/Group",{title:"Group",size:{w:240,h:160},onDraw(e,{ctx:t,theme:o}){const{x:s,y:n,w:r,h:i}=e.computed,a=e.state.color||"#39424e",d=o.text||"#e9e9ef";var h,l,c,u,p,f;t.fillStyle=((e,t)=>{const o=e.replace("#",""),s=parseInt(3===o.length?o.split("").map(e=>e+e).join(""):o,16);return`rgba(${s>>16&255},${s>>8&255},${255&s},${t})`})(a,.5),l=s,c=n,(u=r)<2*(f=10)&&(f=u/2),(p=i)<2*f&&(f=p/2),(h=t).beginPath(),h.moveTo(l+f,c),h.arcTo(l+u,c,l+u,c+p,f),h.arcTo(l+u,c+p,l,c+p,f),h.arcTo(l,c+p,l,c,f),h.arcTo(l,c,l+u,c,f),h.closePath(),t.fill(),t.fillStyle=a,t.beginPath(),t.roundRect(s,n,r,28,[10,10,0,0]),t.fill(),t.fillStyle=d,t.font="12px system-ui",t.textBaseline="middle",t.fillText(e.title,s+10,n+11)}}),h.resize(e.clientWidth,e.clientHeight),u.render();const f=new ResizeObserver(()=>{h.resize(e.clientWidth,e.clientHeight),u.render()});f.observe(e);const g={addGroup:(e={})=>{u.graph.groupManager.addGroup(e),u.render()},graph:a,renderer:h,render:()=>u.render(),start:()=>p.start(),stop:()=>p.stop(),destroy:()=>{p.stop(),f.disconnect(),u.destructor(),l.destroy()}};return n&&p.start(),g},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=free-node.umd.js.map
