{"version":3,"file":"free-node.umd.js","sources":["../src/core/Registry.js","../src/utils/utils.js","../src/core/Node.js","../src/core/Edge.js","../src/groups/GroupManager.js","../src/core/Graph.js","../src/render/hitTest.js","../src/render/CanvasRenderer.js","../src/core/commands.js","../src/core/CommandStack.js","../src/interact/Controller.js","../src/core/Runner.js","../src/render/HtmlOverlay.js","../src/index.js","../src/core/Hooks.js"],"sourcesContent":["// src/core/Registry.js\r\n\r\n/**\r\n * Registry for managing node type definitions\r\n */\r\nexport class Registry {\r\n  constructor() {\r\n    this.types = new Map();\r\n  }\r\n\r\n  /**\r\n   * Register a new node type\r\n   * @param {string} type - Unique type identifier (e.g., \"core/Note\")\r\n   * @param {Object} def - Node definition\r\n   * @param {string} [def.title] - Display title\r\n   * @param {Object} [def.size] - Default size {w, h}\r\n   * @param {Array} [def.inputs] - Input port definitions\r\n   * @param {Array} [def.outputs] - Output port definitions\r\n   * @param {Function} [def.onCreate] - Called when node is created\r\n   * @param {Function} [def.onExecute] - Called each execution cycle\r\n   * @param {Function} [def.onDraw] - Custom drawing function\r\n   * @param {Object} [def.html] - HTML overlay configuration\r\n   * @throws {Error} If type is already registered or invalid\r\n   */\r\n  register(type, def) {\r\n    if (!type || typeof type !== 'string') {\r\n      throw new Error(`Invalid node type: type must be a non-empty string, got ${typeof type}`);\r\n    }\r\n    if (!def || typeof def !== 'object') {\r\n      throw new Error(`Invalid definition for type \"${type}\": definition must be an object`);\r\n    }\r\n    if (this.types.has(type)) {\r\n      throw new Error(`Node type \"${type}\" is already registered. Use unregister() first to replace it.`);\r\n    }\r\n    this.types.set(type, def);\r\n  }\r\n\r\n  /**\r\n   * Unregister a node type\r\n   * @param {string} type - Type identifier to unregister\r\n   * @throws {Error} If type doesn't exist\r\n   */\r\n  unregister(type) {\r\n    if (!this.types.has(type)) {\r\n      throw new Error(`Cannot unregister type \"${type}\": type is not registered`);\r\n    }\r\n    this.types.delete(type);\r\n  }\r\n\r\n  /**\r\n   * Remove all registered node types\r\n   */\r\n  removeAll() {\r\n    this.types.clear();\r\n  }\r\n\r\n  /**\r\n   * Get the definition for a registered node type\r\n   * @param {string} type - Type identifier\r\n   * @returns {Object} Node definition\r\n   * @throws {Error} If type is not registered\r\n   */\r\n  createInstance(type) {\r\n    const def = this.types.get(type);\r\n    if (!def) {\r\n      const available = Array.from(this.types.keys()).join(', ') || 'none';\r\n      throw new Error(`Unknown node type: \"${type}\". Available types: ${available}`);\r\n    }\r\n    return def;\r\n  }\r\n}\r\n","export function randomUUID() {\r\n  // 1) 전역 객체 안전 획득\r\n  const g =\r\n    typeof globalThis !== \"undefined\" ? globalThis :\r\n    typeof self !== \"undefined\" ? self :\r\n    typeof window !== \"undefined\" ? window :\r\n    typeof global !== \"undefined\" ? global : {};\r\n\r\n  const c = g.crypto || g.msCrypto; // IE11 호환\r\n\r\n  // 2) 네이티브 지원 (브라우저/Deno 등)\r\n  if (c && typeof c.randomUUID === \"function\") {\r\n    return c.randomUUID();\r\n  }\r\n\r\n  // 3) Web Crypto만 있는 경우 (getRandomValues로 직접 생성)\r\n  if (c && typeof c.getRandomValues === \"function\") {\r\n    const bytes = new Uint8Array(16);\r\n    c.getRandomValues(bytes);\r\n    // RFC4122 버전/변형 비트 설정\r\n    bytes[6] = (bytes[6] & 0x0f) | 0x40;\r\n    bytes[8] = (bytes[8] & 0x3f) | 0x80;\r\n\r\n    const hex = Array.from(bytes, (b) => b.toString(16).padStart(2, \"0\"));\r\n    return (\r\n      hex.slice(0, 4).join(\"\") + \"-\" +\r\n      hex.slice(4, 6).join(\"\") + \"-\" +\r\n      hex.slice(6, 8).join(\"\") + \"-\" +\r\n      hex.slice(8, 10).join(\"\") + \"-\" +\r\n      hex.slice(10, 16).join(\"\")\r\n    );\r\n  }\r\n\r\n  // 4) Node.js 전용 대체 (require가 있을 때)\r\n  try {\r\n    // 번들러/ESM 충돌 피하려고 런타임에만 require 접근\r\n     \r\n    const req = Function('return typeof require === \"function\" ? require : null')();\r\n    if (req) {\r\n      const nodeCrypto = req(\"crypto\");\r\n      if (typeof nodeCrypto.randomUUID === \"function\") {\r\n        return nodeCrypto.randomUUID();\r\n      }\r\n      const bytes = nodeCrypto.randomBytes(16);\r\n      bytes[6] = (bytes[6] & 0x0f) | 0x40;\r\n      bytes[8] = (bytes[8] & 0x3f) | 0x80;\r\n\r\n      const hex = Array.from(bytes, (b) => b.toString(16).padStart(2, \"0\"));\r\n      return (\r\n        hex.slice(0, 4).join(\"\") + \"-\" +\r\n        hex.slice(4, 6).join(\"\") + \"-\" +\r\n        hex.slice(6, 8).join(\"\") + \"-\" +\r\n        hex.slice(8, 10).join(\"\") + \"-\" +\r\n        hex.slice(10, 16).join(\"\")\r\n      );\r\n    }\r\n  } catch {\r\n    // ignore\r\n  }\r\n\r\n  // 5) 최후의 비보안 대체 (CSPRNG 아님!)\r\n  const bytes = new Uint8Array(16);\r\n  for (let i = 0; i < 16; i++) bytes[i] = Math.floor(Math.random() * 256);\r\n  bytes[6] = (bytes[6] & 0x0f) | 0x40;\r\n  bytes[8] = (bytes[8] & 0x3f) | 0x80;\r\n\r\n  const hex = Array.from(bytes, (b) => b.toString(16).padStart(2, \"0\"));\r\n  return (\r\n    hex.slice(0, 4).join(\"\") + \"-\" +\r\n    hex.slice(4, 6).join(\"\") + \"-\" +\r\n    hex.slice(6, 8).join(\"\") + \"-\" +\r\n    hex.slice(8, 10).join(\"\") + \"-\" +\r\n    hex.slice(10, 16).join(\"\")\r\n  );\r\n}","import { randomUUID } from \"../utils/utils.js\";\r\n\r\n// src/core/Node.js\r\n\r\n/**\r\n * Node represents a single node in the graph\r\n */\r\nexport class Node {\r\n  /**\r\n   * Create a new Node\r\n   * @param {Object} options - Node configuration\r\n   * @param {string} [options.id] - Unique identifier (auto-generated if not provided)\r\n   * @param {string} options.type - Node type identifier\r\n   * @param {string} [options.title] - Display title (defaults to type)\r\n   * @param {number} [options.x=0] - X position\r\n   * @param {number} [options.y=0] - Y position\r\n   * @param {number} [options.width=160] - Node width\r\n   * @param {number} [options.height=60] - Node height\r\n   */\r\n  constructor({ id, type, title, x = 0, y = 0, width = 160, height = 60 }) {\r\n    if (!type) {\r\n      throw new Error(\"Node type is required\");\r\n    }\r\n    this.id = id ?? randomUUID();\r\n    this.type = type;\r\n    this.title = title ?? type;\r\n    this.pos = { x, y };\r\n    this.size = { width, height };\r\n    this.inputs = []; // {id,name,datatype}\r\n    this.outputs = []; // {id,name,datatype}\r\n    this.state = {}; // User state data\r\n\r\n    // Tree Structure\r\n    this.parent = null; // Parent Node (or null if root)\r\n    this.children = new Set(); // Set<Node>\r\n    this.computed = { x: 0, y: 0, w: 0, h: 0 }; // World Transform\r\n  }\r\n\r\n  /**\r\n   * Add an input port to this node\r\n   * @param {string} name - Port name\r\n   * @param {string} [datatype=\"any\"] - Data type for the port\r\n   * @returns {Object} The created port\r\n   */\r\n  addInput(name, datatype = \"any\") {\r\n    if (!name || typeof name !== \"string\") {\r\n      throw new Error(\"Input port name must be a non-empty string\");\r\n    }\r\n    const port = { id: randomUUID(), name, datatype, dir: \"in\" };\r\n    this.inputs.push(port);\r\n    return port;\r\n  }\r\n\r\n  /**\r\n   * Add an output port to this node\r\n   * @param {string} name - Port name\r\n   * @param {string} [datatype=\"any\"] - Data type for the port\r\n   * @returns {Object} The created port\r\n   */\r\n  addOutput(name, datatype = \"any\") {\r\n    if (!name || typeof name !== \"string\") {\r\n      throw new Error(\"Output port name must be a non-empty string\");\r\n    }\r\n    const port = { id: randomUUID(), name, datatype, dir: \"out\" };\r\n    this.outputs.push(port);\r\n    return port;\r\n  }\r\n}\r\n","import { randomUUID } from \"../utils/utils.js\";\r\n\r\n// src/core/Edge.js\r\n\r\n/**\r\n * Edge represents a connection between two node ports\r\n */\r\nexport class Edge {\r\n  /**\r\n   * Create a new Edge\r\n   * @param {Object} options - Edge configuration\r\n   * @param {string} [options.id] - Unique identifier (auto-generated if not provided)\r\n   * @param {string} options.fromNode - Source node ID\r\n   * @param {string} options.fromPort - Source port ID\r\n   * @param {string} options.toNode - Target node ID\r\n   * @param {string} options.toPort - Target port ID\r\n   */\r\n  constructor({ id, fromNode, fromPort, toNode, toPort }) {\r\n    if (!fromNode || !fromPort || !toNode || !toPort) {\r\n      throw new Error(\"Edge requires fromNode, fromPort, toNode, and toPort\");\r\n    }\r\n    this.id = id ?? randomUUID();\r\n    this.fromNode = fromNode;\r\n    this.fromPort = fromPort;\r\n    this.toNode = toNode;\r\n    this.toPort = toPort;\r\n  }\r\n}\r\n","// src/groups/GroupManager.js\r\nimport { randomUUID } from \"/src/utils/utils.js\";\r\n\r\nexport class GroupManager {\r\n  constructor({ graph, hooks }) {\r\n    this.graph = graph;\r\n    this.hooks = hooks;\r\n  }\r\n\r\n  // ---------- CRUD ----------\r\n  addGroup({\r\n    title = \"Group\",\r\n    x = 0,\r\n    y = 0,\r\n    width = 240,\r\n    height = 160,\r\n    color = \"#39424e\",\r\n    members = [],\r\n  } = {}) {\r\n    // Validate parameters\r\n    if (width < 100 || height < 60) {\r\n      console.warn(\"Group size too small, using minimum size\");\r\n      width = Math.max(100, width);\r\n      height = Math.max(60, height);\r\n    }\r\n\r\n    const groupNode = this.graph.addNode(\"core/Group\", {\r\n      title,\r\n      x,\r\n      y,\r\n      width,\r\n      height,\r\n    });\r\n    groupNode.state.color = color;\r\n\r\n    // Reparent members with validation\r\n    for (const memberId of members) {\r\n      const node = this.graph.getNodeById(memberId);\r\n      if (node) {\r\n        if (node.type === \"core/Group\") {\r\n          console.warn(`Cannot add group ${memberId} as member of another group`);\r\n          continue;\r\n        }\r\n        this.graph.reparent(node, groupNode);\r\n      } else {\r\n        console.warn(`Member node ${memberId} not found, skipping`);\r\n      }\r\n    }\r\n    \r\n    this.hooks?.emit(\"group:change\");\r\n    return groupNode;\r\n  }\r\n\r\n  addGroupFromSelection({ title = \"Group\", margin = { x: 12, y: 12 } } = {}) {\r\n    // Controller에서 selection을 받아와야 함.\r\n    // 여기서는 간단히 graph.nodes를 순회하며 selected 상태를 확인한다고 가정하거나\r\n    // 외부에서 members를 넘겨받는 것이 좋음.\r\n    // 일단은 외부에서 members를 넘겨받는 addGroup을 활용.\r\n    return null; \r\n  }\r\n\r\n  removeGroup(id) {\r\n    const groupNode = this.graph.getNodeById(id);\r\n    if (!groupNode || groupNode.type !== \"core/Group\") return;\r\n\r\n    // Ungroup: reparent children to group's parent\r\n    const children = [...groupNode.children];\r\n    for (const child of children) {\r\n      this.graph.reparent(child, groupNode.parent);\r\n    }\r\n\r\n    this.graph.removeNode(id);\r\n    this.hooks?.emit(\"group:change\");\r\n  }\r\n\r\n  // ---------- 이동/리사이즈 ----------\r\n  // 이제 Node의 이동/리사이즈 로직을 따름.\r\n  // Controller에서 Node 이동 시 updateWorldTransforms가 호출되므로 자동 처리됨.\r\n\r\n  resizeGroup(id, dw, dh) {\r\n    const g = this.graph.getNodeById(id);\r\n    if (!g || g.type !== \"core/Group\") return;\r\n    \r\n    const minW = 100;\r\n    const minH = 60;\r\n    g.size.width = Math.max(minW, g.size.width + dw);\r\n    g.size.height = Math.max(minH, g.size.height + dh);\r\n    \r\n    this.graph.updateWorldTransforms();\r\n    this.hooks?.emit(\"group:change\");\r\n  }\r\n\r\n  // ---------- 히트테스트 & 드래그 ----------\r\n  // 이제 Group도 Node이므로 Controller의 Node 히트테스트 로직을 따름.\r\n  // 단, Resize Handle은 별도 처리가 필요할 수 있음.\r\n\r\n  hitTestResizeHandle(x, y) {\r\n    const handleSize = 10;\r\n    // 역순 순회 (위에 있는 것부터)\r\n    const nodes = [...this.graph.nodes.values()].reverse();\r\n    \r\n    for (const node of nodes) {\r\n      if (node.type !== \"core/Group\") continue;\r\n      \r\n      // World Transform 사용\r\n      const { x: gx, y: gy, w: gw, h: gh } = node.computed;\r\n      \r\n      if (\r\n        x >= gx + gw - handleSize &&\r\n        x <= gx + gw &&\r\n        y >= gy + gh - handleSize &&\r\n        y <= gy + gh\r\n      ) {\r\n        return { group: node, handle: \"se\" };\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n}\r\n","import { Node } from \"./Node.js\";\r\nimport { Edge } from \"./Edge.js\";\r\nimport { GroupManager } from \"../groups/GroupManager.js\";\r\n\r\n/**\r\n * Graph manages the collection of nodes and edges\r\n */\r\nexport class Graph {\r\n  /**\r\n   * Create a new Graph\r\n   * @param {Object} options - Graph configuration\r\n   * @param {Object} options.hooks - Event hooks system\r\n   * @param {Object} options.registry - Node type registry\r\n   */\r\n  constructor({ hooks, registry }) {\r\n    if (!registry) {\r\n      throw new Error(\"Graph requires a registry\");\r\n    }\r\n    this.nodes = new Map();\r\n    this.edges = new Map();\r\n    this.hooks = hooks;\r\n    this.registry = registry;\r\n    // double buffer for deterministic cycles\r\n    this._valuesA = new Map(); // current\r\n    this._valuesB = new Map(); // next\r\n    this._useAasCurrent = true;\r\n\r\n    this.groupManager = new GroupManager({\r\n      graph: this,\r\n      hooks: this.hooks,\r\n    });\r\n  }\r\n  /**\r\n   * Get a node by its ID\r\n   * @param {string} id - Node ID\r\n   * @returns {Node|null} The node or null if not found\r\n   */\r\n  getNodeById(id) {\r\n    return this.nodes.get(id) || null;\r\n  }\r\n  /**\r\n   * Add a node to the graph\r\n   * @param {string} type - Node type identifier\r\n   * @param {Object} [opts={}] - Additional node options (x, y, width, height, etc.)\r\n   * @returns {Node} The created node\r\n   * @throws {Error} If node type is not registered\r\n   */\r\n  addNode(type, opts = {}) {\r\n    const def = this.registry.types.get(type);\r\n    if (!def) {\r\n      const available = Array.from(this.registry.types.keys()).join(\", \") || \"none\";\r\n      throw new Error(`Unknown node type: \"${type}\". Available types: ${available}`);\r\n    }\r\n    const node = new Node({\r\n      type,\r\n      title: def.title,\r\n      width: def.size?.w,\r\n      height: def.size?.h,\r\n      ...opts,\r\n    });\r\n    for (const i of def.inputs || []) node.addInput(i.name, i.datatype);\r\n    for (const o of def.outputs || []) node.addOutput(o.name, o.datatype);\r\n    def.onCreate?.(node);\r\n    this.nodes.set(node.id, node);\r\n    this.hooks?.emit(\"node:create\", node);\r\n    return node;\r\n  }\r\n  /**\r\n   * Remove a node and its connected edges from the graph\r\n   * @param {string} nodeId - ID of the node to remove\r\n   */\r\n  removeNode(nodeId) {\r\n    // Remove all edges connected to this node\r\n    for (const [eid, e] of this.edges) {\r\n      if (e.fromNode === nodeId || e.toNode === nodeId) {\r\n        this.edges.delete(eid);\r\n      }\r\n    }\r\n    this.nodes.delete(nodeId);\r\n  }\r\n  /**\r\n   * Add an edge connecting two node ports\r\n   * @param {string} fromNode - Source node ID\r\n   * @param {string} fromPort - Source port ID\r\n   * @param {string} toNode - Target node ID\r\n   * @param {string} toPort - Target port ID\r\n   * @returns {Edge} The created edge\r\n   * @throws {Error} If nodes don't exist\r\n   */\r\n  addEdge(fromNode, fromPort, toNode, toPort) {\r\n    // Validate nodes exist\r\n    if (!this.nodes.has(fromNode)) {\r\n      throw new Error(`Cannot create edge: source node \"${fromNode}\" not found`);\r\n    }\r\n    if (!this.nodes.has(toNode)) {\r\n      throw new Error(`Cannot create edge: target node \"${toNode}\" not found`);\r\n    }\r\n\r\n    const e = new Edge({ fromNode, fromPort, toNode, toPort });\r\n    this.edges.set(e.id, e);\r\n    this.hooks?.emit(\"edge:create\", e);\r\n    return e;\r\n  }\r\n\r\n  /**\r\n   * Clear all nodes and edges from the graph\r\n   */\r\n  clear() {\r\n    this.nodes.clear();\r\n    this.edges.clear();\r\n  }\r\n\r\n  updateWorldTransforms() {\r\n    // 1. Find roots\r\n    const roots = [];\r\n    for (const n of this.nodes.values()) {\r\n      if (!n.parent) roots.push(n);\r\n    }\r\n\r\n    // 2. Traverse\r\n    const stack = roots.map((n) => ({ node: n, px: 0, py: 0 }));\r\n    while (stack.length > 0) {\r\n      const { node, px, py } = stack.pop();\r\n      node.computed.x = px + node.pos.x;\r\n      node.computed.y = py + node.pos.y;\r\n      node.computed.w = node.size.width;\r\n      node.computed.h = node.size.height;\r\n\r\n      for (const child of node.children) {\r\n        stack.push({ node: child, px: node.computed.x, py: node.computed.y });\r\n      }\r\n    }\r\n  }\r\n\r\n  reparent(node, newParent) {\r\n    if (node.parent === newParent) return;\r\n\r\n    // 1. Calculate current world pos\r\n    const wx = node.computed.x;\r\n    const wy = node.computed.y;\r\n\r\n    // 2. Remove from old parent\r\n    if (node.parent) {\r\n      node.parent.children.delete(node);\r\n    }\r\n\r\n    // 3. Add to new parent\r\n    node.parent = newParent;\r\n    if (newParent) {\r\n      newParent.children.add(node);\r\n      // 4. Calculate new local pos\r\n      // world = parentWorld + local => local = world - parentWorld\r\n      node.pos.x = wx - newParent.computed.x;\r\n      node.pos.y = wy - newParent.computed.y;\r\n    } else {\r\n      // Root\r\n      node.pos.x = wx;\r\n      node.pos.y = wy;\r\n    }\r\n    \r\n    this.updateWorldTransforms();\r\n  }\r\n\r\n  // buffer helpers\r\n  _curBuf() {\r\n    return this._useAasCurrent ? this._valuesA : this._valuesB;\r\n  }\r\n  _nextBuf() {\r\n    return this._useAasCurrent ? this._valuesB : this._valuesA;\r\n  }\r\n  swapBuffers() {\r\n    // when moving to next cycle, promote next->current and clear next\r\n    this._useAasCurrent = !this._useAasCurrent;\r\n    this._nextBuf().clear();\r\n  }\r\n  // data helpers\r\n  setOutput(nodeId, portId, value) {\r\n    this._nextBuf().set(`${nodeId}:${portId}`, value);\r\n  }\r\n  getInput(nodeId, portId) {\r\n    // find upstream edge feeding this input\r\n    for (const e of this.edges.values()) {\r\n      if (e.toNode === nodeId && e.toPort === portId) {\r\n        return this._curBuf().get(`${e.fromNode}:${e.fromPort}`);\r\n      }\r\n    }\r\n    return undefined;\r\n  }\r\n  toJSON() {\r\n    const json = {\r\n      nodes: [...this.nodes.values()].map((n) => ({\r\n        id: n.id,\r\n        type: n.type,\r\n        title: n.title,\r\n        x: n.pos.x,\r\n        y: n.pos.y,\r\n        w: n.size.width,\r\n        h: n.size.height,\r\n        inputs: n.inputs,\r\n        outputs: n.outputs,\r\n        state: n.state,\r\n      })),\r\n      edges: [...this.edges.values()],\r\n    };\r\n    this.hooks?.emit(\"graph:serialize\", json);\r\n    return json;\r\n  }\r\n  fromJSON(json) {\r\n    this.clear();\r\n    for (const nd of json.nodes) {\r\n      const node = new Node({\r\n        id: nd.id,\r\n        type: nd.type,\r\n        title: nd.title,\r\n        x: nd.x,\r\n        y: nd.y,\r\n        width: nd.w,\r\n        height: nd.h,\r\n      });\r\n      node.inputs = nd.inputs;\r\n      node.outputs = nd.outputs;\r\n      node.state = nd.state || {};\r\n      this.nodes.set(node.id, node);\r\n    }\r\n    for (const ed of json.edges) this.edges.set(ed.id, new Edge(ed));\r\n    return this;\r\n  }\r\n}\r\n","// src/render/hitTest.js\r\nexport function hitTestNode(node, x, y) {\r\n  const { x: nx, y: ny, w: width, h: height } = node.computed || {\r\n    x: node.pos.x,\r\n    y: node.pos.y,\r\n    w: node.size.width,\r\n    h: node.size.height,\r\n  };\r\n  return x >= nx && x <= nx + width && y >= ny && y <= ny + height;\r\n}\r\n\r\nexport function portRect(node, port, idx, dir) {\r\n  const { x: nx, y: ny, w: width } = node.computed || {\r\n    x: node.pos.x,\r\n    y: node.pos.y,\r\n    w: node.size.width,\r\n  };\r\n  const pad = 8,\r\n    row = 20;\r\n  const y = ny + 28 + idx * row;\r\n  if (dir === \"in\") return { x: nx - pad, y, w: pad, h: 14 };\r\n  if (dir === \"out\") return { x: nx + width, y, w: pad, h: 14 };\r\n}\r\n","import { hitTestNode, portRect } from \"./hitTest.js\";\r\n\r\nexport class CanvasRenderer {\r\n  static FONT_SIZE = 12;\r\n  constructor(canvas, { theme = {}, registry, edgeStyle = \"orthogonal\" } = {}) {\r\n    this.canvas = canvas;\r\n    this.ctx = canvas.getContext(\"2d\");\r\n    this.registry = registry; // to call per-node onDraw\r\n\r\n    // viewport transform\r\n    this.scale = 1;\r\n    this.minScale = 0.25;\r\n    this.maxScale = 3;\r\n    this.offsetX = 0;\r\n    this.offsetY = 0;\r\n\r\n    // 'bezier' | 'line' | 'orthogonal'\r\n    this.edgeStyle = edgeStyle;\r\n\r\n    this.theme = Object.assign(\r\n      {\r\n        bg: \"#141417\",\r\n        grid: \"#25252a\",\r\n        node: \"#1e1e24\",\r\n        title: \"#2a2a31\",\r\n        text: \"#e9e9ef\",\r\n        port: \"#8aa1ff\",\r\n        edge: \"#7f8cff\",\r\n      },\r\n      theme\r\n    );\r\n  }\r\n  setEdgeStyle(style) {\r\n    this.edgeStyle =\r\n      style === \"line\" || style === \"orthogonal\" ? style : \"bezier\";\r\n  }\r\n  setRegistry(reg) {\r\n    this.registry = reg;\r\n  }\r\n  resize(w, h) {\r\n    this.canvas.width = w;\r\n    this.canvas.height = h;\r\n  }\r\n  setTransform({\r\n    scale = this.scale,\r\n    offsetX = this.offsetX,\r\n    offsetY = this.offsetY,\r\n  } = {}) {\r\n    this.scale = Math.min(this.maxScale, Math.max(this.minScale, scale));\r\n    this.offsetX = offsetX;\r\n    this.offsetY = offsetY;\r\n  }\r\n  panBy(dx, dy) {\r\n    this.offsetX += dx;\r\n    this.offsetY += dy;\r\n  }\r\n  zoomAt(factor, cx, cy) {\r\n    // factor > 1 zoom in, < 1 zoom out, centered at screen point (cx, cy)\r\n    const prev = this.scale;\r\n    const next = Math.min(\r\n      this.maxScale,\r\n      Math.max(this.minScale, prev * factor)\r\n    );\r\n    if (next === prev) return;\r\n    // keep the world point under cursor fixed: adjust offset\r\n    const wx = (cx - this.offsetX) / prev;\r\n    const wy = (cy - this.offsetY) / prev;\r\n    this.offsetX = cx - wx * next;\r\n    this.offsetY = cy - wy * next;\r\n    this.scale = next;\r\n  }\r\n\r\n  screenToWorld(x, y) {\r\n    return {\r\n      x: (x - this.offsetX) / this.scale,\r\n      y: (y - this.offsetY) / this.scale,\r\n    };\r\n  }\r\n  worldToScreen(x, y) {\r\n    return {\r\n      x: x * this.scale + this.offsetX,\r\n      y: y * this.scale + this.offsetY,\r\n    };\r\n  }\r\n  _applyTransform() {\r\n    const { ctx } = this;\r\n    ctx.setTransform(this.scale, 0, 0, this.scale, this.offsetX, this.offsetY);\r\n  }\r\n  _resetTransform() {\r\n    this.ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n  }\r\n\r\n  // ── Drawing ────────────────────────────────────────────────────────────────\r\n  _drawArrowhead(x1, y1, x2, y2, size = 10) {\r\n    const { ctx } = this;\r\n    const s = size / this.scale; // 줌에 따라 크기 보정\r\n    const ang = Math.atan2(y2 - y1, x2 - x1);\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(x2, y2);\r\n    ctx.lineTo(\r\n      x2 - s * Math.cos(ang - Math.PI / 6),\r\n      y2 - s * Math.sin(ang - Math.PI / 6)\r\n    );\r\n    ctx.lineTo(\r\n      x2 - s * Math.cos(ang + Math.PI / 6),\r\n      y2 - s * Math.sin(ang + Math.PI / 6)\r\n    );\r\n    ctx.closePath();\r\n    ctx.fill(); // 선 색상과 동일한 fill이 자연스러움\r\n  }\r\n\r\n  _drawScreenText(\r\n    text,\r\n    lx,\r\n    ly,\r\n    {\r\n      fontPx = 12,\r\n      color = this.theme.text,\r\n      align = \"left\",\r\n      baseline = \"alphabetic\",\r\n      dpr = 1, // 추후 devicePixelRatio 도입\r\n    } = {}\r\n  ) {\r\n    const { ctx } = this;\r\n    const { x: sx, y: sy } = this.worldToScreen(lx, ly);\r\n\r\n    ctx.save();\r\n    // 화면 좌표계(스케일=1)로 리셋\r\n    this._resetTransform();\r\n\r\n    // 픽셀 스냅(번짐 방지)\r\n    const px = Math.round(sx) + 0.5;\r\n    const py = Math.round(sy) + 0.5;\r\n\r\n    ctx.font = `${fontPx * this.scale}px system-ui`;\r\n    ctx.fillStyle = color;\r\n    ctx.textAlign = align;\r\n    ctx.textBaseline = baseline;\r\n    ctx.fillText(text, px, py);\r\n    ctx.restore();\r\n  }\r\n\r\n  drawGrid() {\r\n    const { ctx, canvas, theme, scale, offsetX, offsetY } = this;\r\n    // clear screen in screen space\r\n\r\n    this._resetTransform();\r\n    ctx.fillStyle = theme.bg;\r\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\r\n\r\n    // draw grid in world space so it pans/zooms\r\n    this._applyTransform();\r\n    ctx.strokeStyle = theme.grid;\r\n    ctx.lineWidth = 1 / scale; // keep 1px apparent\r\n\r\n    const base = 20; // world units\r\n    const step = base;\r\n\r\n    // visible world bounds\r\n    const x0 = -offsetX / scale;\r\n    const y0 = -offsetY / scale;\r\n    const x1 = (canvas.width - offsetX) / scale;\r\n    const y1 = (canvas.height - offsetY) / scale;\r\n\r\n    const startX = Math.floor(x0 / step) * step;\r\n    const startY = Math.floor(y0 / step) * step;\r\n\r\n    ctx.beginPath();\r\n    for (let x = startX; x <= x1; x += step) {\r\n      ctx.moveTo(x, y0);\r\n      ctx.lineTo(x, y1);\r\n    }\r\n    for (let y = startY; y <= y1; y += step) {\r\n      ctx.moveTo(x0, y);\r\n      ctx.lineTo(x1, y);\r\n    }\r\n    ctx.stroke();\r\n\r\n    this._resetTransform();\r\n  }\r\n\r\n  draw(\r\n    graph,\r\n    {\r\n      selection = new Set(),\r\n      tempEdge = null,\r\n      running = false,\r\n      time = performance.now(),\r\n      dt = 0,\r\n      groups = null,\r\n    } = {}\r\n  ) {\r\n    // Update transforms first\r\n    graph.updateWorldTransforms();\r\n\r\n    this.drawGrid();\r\n    const { ctx, theme } = this;\r\n    this._applyTransform();\r\n\r\n    ctx.save();\r\n    if (running) {\r\n      const speed = 120; // px/s\r\n      const phase =\r\n        (((time / 1000) * speed) / this.scale) % CanvasRenderer.FONT_SIZE;\r\n      ctx.setLineDash([6 / this.scale, 6 / this.scale]);\r\n      ctx.lineDashOffset = -phase;\r\n    } else {\r\n      ctx.setLineDash([]);\r\n      ctx.lineDashOffset = 0;\r\n    }\r\n\r\n    // 1. Draw Groups (Backgrounds)\r\n    for (const n of graph.nodes.values()) {\r\n      if (n.type === \"core/Group\") {\r\n        const sel = selection.has(n.id);\r\n        const def = this.registry?.types?.get(n.type);\r\n        if (def?.onDraw) def.onDraw(n, { ctx, theme });\r\n        else this._drawNode(n, sel);\r\n      }\r\n    }\r\n\r\n    // 2. Draw Edges\r\n    ctx.strokeStyle = theme.edge;\r\n    ctx.lineWidth = 2 * this.scale;\r\n    for (const e of graph.edges.values()) this._drawEdge(graph, e);\r\n\r\n    // temp edge (given in screen coords); convert to world if needed\r\n    if (tempEdge) {\r\n      const a = this.screenToWorld(tempEdge.x1, tempEdge.y1);\r\n      const b = this.screenToWorld(tempEdge.x2, tempEdge.y2);\r\n\r\n      // 점선 프리뷰\r\n      const prevDash = this.ctx.getLineDash();\r\n      this.ctx.setLineDash([6 / this.scale, 6 / this.scale]);\r\n\r\n      let ptsForArrow = null;\r\n      if (this.edgeStyle === \"line\") {\r\n        this._drawLine(a.x, a.y, b.x, b.y);\r\n        ptsForArrow = [\r\n          { x: a.x, y: a.y },\r\n          { x: b.x, y: b.y },\r\n        ];\r\n      } else if (this.edgeStyle === \"orthogonal\") {\r\n        ptsForArrow = this._drawOrthogonal(a.x, a.y, b.x, b.y);\r\n      } else {\r\n        this._drawCurve(a.x, a.y, b.x, b.y);\r\n        ptsForArrow = [\r\n          { x: a.x, y: a.y },\r\n          { x: b.x, y: b.y },\r\n        ];\r\n      }\r\n\r\n      this.ctx.setLineDash(prevDash);\r\n\r\n      // 화살표 표시: 마지막 세그먼트 방향 사용\r\n      if (ptsForArrow && ptsForArrow.length >= 2) {\r\n        const p1 = ptsForArrow[ptsForArrow.length - 2];\r\n        const p2 = ptsForArrow[ptsForArrow.length - 1];\r\n        this.ctx.fillStyle = this.theme.edge;\r\n        this.ctx.strokeStyle = this.theme.edge;\r\n        this._drawArrowhead(p1.x, p1.y, p2.x, p2.y, 12);\r\n      }\r\n    }\r\n    ctx.restore();\r\n\r\n    // 3. Draw Other Nodes\r\n    for (const n of graph.nodes.values()) {\r\n      if (n.type !== \"core/Group\") {\r\n        const sel = selection.has(n.id);\r\n        this._drawNode(n, sel);\r\n        const def = this.registry?.types?.get(n.type);\r\n        if (def?.onDraw) def.onDraw(n, { ctx, theme });\r\n      }\r\n    }\r\n\r\n    this._resetTransform();\r\n  }\r\n\r\n  _rgba(hex, a) {\r\n    const c = hex.replace(\"#\", \"\");\r\n    const n = parseInt(\r\n      c.length === 3\r\n        ? c\r\n            .split(\"\")\r\n            .map((x) => x + x)\r\n            .join(\"\")\r\n        : c,\r\n      16\r\n    );\r\n    const r = (n >> 16) & 255,\r\n      g = (n >> 8) & 255,\r\n      b = n & 255;\r\n    return `rgba(${r},${g},${b},${a})`;\r\n  }\r\n\r\n  _drawNode(node, selected) {\r\n    const { ctx, theme } = this;\r\n    const r = 8;\r\n    const { x, y, w, h } = node.computed;\r\n    ctx.fillStyle = theme.node;\r\n    ctx.strokeStyle = selected ? \"#6cf\" : \"#333\";\r\n    ctx.lineWidth = (selected ? 2 : 1.2) / this.scale;\r\n    roundRect(ctx, x, y, w, h, r);\r\n    ctx.fill();\r\n    ctx.stroke();\r\n    ctx.fillStyle = theme.title;\r\n    roundRect(ctx, x, y, w, 24, { tl: r, tr: r, br: 0, bl: 0 });\r\n    ctx.fill();\r\n\r\n    this._drawScreenText(node.title, x + 8, y + CanvasRenderer.FONT_SIZE, {\r\n      fontPx: CanvasRenderer.FONT_SIZE,\r\n      color: theme.text,\r\n      baseline: \"middle\",\r\n      align: \"left\",\r\n    });\r\n    ctx.fillStyle = theme.port;\r\n    node.inputs.forEach((p, i) => {\r\n      const rct = portRect(node, p, i, \"in\");\r\n      ctx.fillRect(rct.x, rct.y, rct.w, rct.h);\r\n    });\r\n    node.outputs.forEach((p, i) => {\r\n      const rct = portRect(node, p, i, \"out\");\r\n      ctx.fillRect(rct.x, rct.y, rct.w, rct.h);\r\n    });\r\n  }\r\n\r\n  _drawEdge(graph, e) {\r\n    const from = graph.nodes.get(e.fromNode);\r\n    const to = graph.nodes.get(e.toNode);\r\n    if (!from || !to) return;\r\n    const iOut = from.outputs.findIndex((p) => p.id === e.fromPort);\r\n    const iIn = to.inputs.findIndex((p) => p.id === e.toPort);\r\n    const pr1 = portRect(from, null, iOut, \"out\");\r\n    const pr2 = portRect(to, null, iIn, \"in\");\r\n    const x1 = pr1.x,\r\n      y1 = pr1.y + 7,\r\n      x2 = pr2.x,\r\n      y2 = pr2.y + 7;\r\n    if (this.edgeStyle === \"line\") {\r\n      this._drawLine(x1, y1, x2, y2);\r\n    } else if (this.edgeStyle === \"orthogonal\") {\r\n      this._drawOrthogonal(x1, y1, x2, y2);\r\n    } else {\r\n      this._drawCurve(x1, y1, x2, y2); // bezier (기존)\r\n    }\r\n  }\r\n\r\n  _drawLine(x1, y1, x2, y2) {\r\n    const { ctx } = this;\r\n    ctx.beginPath();\r\n    ctx.moveTo(x1, y1);\r\n    ctx.lineTo(x2, y2);\r\n    ctx.stroke();\r\n  }\r\n\r\n  _drawPolyline(points) {\r\n    const { ctx } = this;\r\n    ctx.beginPath();\r\n    ctx.moveTo(points[0].x, points[0].y);\r\n    for (let i = 1; i < points.length; i++)\r\n      ctx.lineTo(points[i].x, points[i].y);\r\n    ctx.stroke();\r\n  }\r\n\r\n  _drawOrthogonal(x1, y1, x2, y2) {\r\n    const dx = Math.abs(x2 - x1);\r\n    const dy = Math.abs(y2 - y1);\r\n    // 중간 축을 결정 (더 짧은 축을 가운데에 두면 보기 좋음)\r\n    const useHVH = true; // 가로-세로-가로(HVH) vs 세로-가로-세로(VHV)\r\n    const midX = (x1 + x2) / 2;\r\n    const midY = (y1 + y2) / 2;\r\n\r\n    let pts;\r\n    if (useHVH) {\r\n      // x1,y1 → midX,y1 → midX,y2 → x2,y2\r\n      pts = [\r\n        { x: x1, y: y1 },\r\n        { x: midX, y: y1 },\r\n        { x: midX, y: y2 },\r\n        { x: x2, y: y2 },\r\n      ];\r\n    }\r\n    // else {\r\n    //   // x1,y1 → x1,midY → x2,midY → x2,y2\r\n    //   pts = [\r\n    //     { x: x1, y: y1 },\r\n    //     { x: x1, y: midY },\r\n    //     { x: x2, y: midY },\r\n    //     { x: x2, y: y2 },\r\n    //   ];\r\n    // }\r\n\r\n    // 라운드 코너\r\n    const { ctx } = this;\r\n    const prevJoin = ctx.lineJoin,\r\n      prevCap = ctx.lineCap;\r\n    ctx.lineJoin = \"round\";\r\n    ctx.lineCap = \"round\";\r\n    this._drawPolyline(pts);\r\n    ctx.lineJoin = prevJoin;\r\n    ctx.lineCap = prevCap;\r\n\r\n    return pts; // 화살표 각도 계산에 사용\r\n  }\r\n  _drawCurve(x1, y1, x2, y2) {\r\n    const { ctx } = this;\r\n    const dx = Math.max(40, Math.abs(x2 - x1) * 0.4);\r\n    ctx.beginPath();\r\n    ctx.moveTo(x1, y1);\r\n    ctx.bezierCurveTo(x1 + dx, y1, x2 - dx, y2, x2, y2);\r\n    ctx.stroke();\r\n  }\r\n}\r\nfunction roundRect(ctx, x, y, w, h, r = 6) {\r\n  if (typeof r === \"number\") r = { tl: r, tr: r, br: r, bl: r };\r\n  ctx.beginPath();\r\n  ctx.moveTo(x + r.tl, y);\r\n  ctx.lineTo(x + w - r.tr, y);\r\n  ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);\r\n  ctx.lineTo(x + w, y + h - r.br);\r\n  ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);\r\n  ctx.lineTo(x + r.bl, y + h);\r\n  ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);\r\n  ctx.lineTo(x, y + r.tl);\r\n  ctx.quadraticCurveTo(x, y, x + r.tl, y);\r\n  ctx.closePath();\r\n}\r\n","// Find an edge id by its endpoints (fallback for undo)\r\nfunction findEdgeId(graph, a, b, c, d) {\r\n  for (const [id, e] of graph.edges) {\r\n    if (\r\n      e.fromNode === a &&\r\n      e.fromPort === b &&\r\n      e.toNode === c &&\r\n      e.toPort === d\r\n    )\r\n      return id;\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function MoveNodeCmd(node, fromPos, toPos) {\r\n  return {\r\n    do() {\r\n      node.pos = { ...toPos };\r\n    },\r\n    undo() {\r\n      node.pos = { ...fromPos };\r\n    },\r\n  };\r\n}\r\n\r\nexport function AddEdgeCmd(graph, fromNode, fromPort, toNode, toPort) {\r\n  let addedId = null;\r\n  return {\r\n    do() {\r\n      graph.addEdge(fromNode, fromPort, toNode, toPort);\r\n      addedId = findEdgeId(graph, fromNode, fromPort, toNode, toPort);\r\n    },\r\n    undo() {\r\n      const id =\r\n        addedId ?? findEdgeId(graph, fromNode, fromPort, toNode, toPort);\r\n      if (id != null) graph.edges.delete(id);\r\n    },\r\n  };\r\n}\r\n\r\nexport function RemoveEdgeCmd(graph, edgeId) {\r\n  const e = graph.edges.get(edgeId);\r\n  if (!e) return null;\r\n  // capture for undo\r\n  const { fromNode, fromPort, toNode, toPort } = e;\r\n  return {\r\n    do() {\r\n      graph.edges.delete(edgeId);\r\n    },\r\n    undo() {\r\n      graph.addEdge(fromNode, fromPort, toNode, toPort);\r\n    },\r\n  };\r\n}\r\n\r\n// Optional: group multiple commands as one (used for \"rewire\")\r\nexport function CompoundCmd(cmds) {\r\n  return {\r\n    do() {\r\n      cmds.forEach((c) => c?.do());\r\n    },\r\n    undo() {\r\n      [...cmds].reverse().forEach((c) => c?.undo());\r\n    },\r\n  };\r\n}\r\n\r\nexport function RemoveNodeCmd(graph, node) {\r\n  let removedNode = null;\r\n  let removedEdges = [];\r\n\r\n  return {\r\n    do() {\r\n      // Store the node and its connected edges for undo\r\n      removedNode = node;\r\n      removedEdges = graph.edges\r\n        ? [...graph.edges.values()].filter((e) => {\r\n            console.log(e);\r\n            return e.fromNode === node.id || e.toNode === node.id;\r\n          })\r\n        : [];\r\n\r\n      // Remove edges first\r\n      for (const edge of removedEdges) {\r\n        graph.edges.delete(edge.id);\r\n      }\r\n      // Remove the node\r\n      graph.nodes.delete(node.id);\r\n    },\r\n\r\n    undo() {\r\n      // Restore node\r\n      if (removedNode) {\r\n        graph.nodes.set(removedNode.id, removedNode);\r\n      }\r\n      // Restore edges\r\n      for (const edge of removedEdges) {\r\n        graph.edges.set(edge.id, edge);\r\n      }\r\n    },\r\n  };\r\n}\r\n\r\nexport function ResizeNodeCmd(node, fromSize, toSize) {\r\n  return {\r\n    do() {\r\n      node.size.width = toSize.w;\r\n      node.size.height = toSize.h;\r\n    },\r\n    undo() {\r\n      node.size.width = fromSize.w;\r\n      node.size.height = fromSize.h;\r\n    },\r\n  };\r\n}\r\n","// src/core/CommandStack.js\r\nexport class CommandStack {\r\n  constructor() {\r\n    this.undoStack = [];\r\n    this.redoStack = [];\r\n  }\r\n  exec(cmd) {\r\n    cmd.do();\r\n    this.undoStack.push(cmd);\r\n    this.redoStack.length = 0;\r\n  }\r\n  undo() {\r\n    const c = this.undoStack.pop();\r\n    if (c) {\r\n      c.undo();\r\n      this.redoStack.push(c);\r\n    }\r\n  }\r\n  redo() {\r\n    const c = this.redoStack.pop();\r\n    if (c) {\r\n      c.do();\r\n      this.undoStack.push(c);\r\n    }\r\n  }\r\n}\r\n","import { hitTestNode, portRect } from \"../render/hitTest.js\";\r\nimport {\r\n  MoveNodeCmd,\r\n  AddEdgeCmd,\r\n  RemoveEdgeCmd,\r\n  CompoundCmd,\r\n  RemoveNodeCmd,\r\n  ResizeNodeCmd,\r\n} from \"../core/commands.js\";\r\nimport { CommandStack } from \"../core/CommandStack.js\";\r\n\r\nexport class Controller {\r\n\r\n  static MIN_NODE_WIDTH = 80;\r\n  static MIN_NODE_HEIGHT = 60;\r\n\r\n  constructor({ graph, renderer, hooks, htmlOverlay }) {\r\n    this.graph = graph;\r\n    this.renderer = renderer;\r\n    this.hooks = hooks;\r\n    this.htmlOverlay = htmlOverlay;\r\n\r\n    this.stack = new CommandStack();\r\n    this.selection = new Set();\r\n    this.dragging = null; // { nodeId, dx, dy }\r\n    this.connecting = null; // { fromNode, fromPort, x(screen), y(screen) }\r\n    this.panning = null; // { x(screen), y(screen) }\r\n    this.resizing = null;\r\n    this.gDragging = null;\r\n    this.gResizing = null;\r\n\r\n    this._cursor = \"default\";\r\n\r\n    this._onKeyPressEvt = this._onKeyPress.bind(this);\r\n    this._onDownEvt = this._onDown.bind(this);\r\n    this._onWheelEvt = this._onWheel.bind(this);\r\n    this._onMoveEvt = this._onMove.bind(this);\r\n    this._onUpEvt = this._onUp.bind(this);\r\n\r\n    this._bindEvents();\r\n  }\r\n\r\n  destructor() {\r\n    const c = this.renderer.canvas;\r\n    c.removeEventListener(\"mousedown\", this._onDownEvt);\r\n    c.removeEventListener(\"wheel\", this._onWheelEvt, { passive: false });\r\n    window.removeEventListener(\"mousemove\", this._onMoveEvt);\r\n    window.removeEventListener(\"mouseup\", this._onUpEvt);\r\n    window.removeEventListener(\"keydown\", this._onKeyPressEvt);\r\n  }\r\n\r\n  _bindEvents() {\r\n    const c = this.renderer.canvas;\r\n    c.addEventListener(\"mousedown\", this._onDownEvt);\r\n    c.addEventListener(\"wheel\", this._onWheelEvt, { passive: false });\r\n    window.addEventListener(\"mousemove\", this._onMoveEvt);\r\n    window.addEventListener(\"mouseup\", this._onUpEvt);\r\n    window.addEventListener(\"keydown\", this._onKeyPressEvt);\r\n  }\r\n\r\n  _onKeyPress(e) {\r\n    // Undo: Ctrl/Cmd + Z  (Shift+Z → Redo)\r\n    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === \"z\") {\r\n      e.preventDefault();\r\n      if (e.shiftKey) this.stack.redo();\r\n      else this.stack.undo();\r\n      this.render();\r\n      return;\r\n    }\r\n\r\n    // Redo: Ctrl/Cmd + Y\r\n    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === \"y\") {\r\n      e.preventDefault();\r\n      this.stack.redo();\r\n      this.render();\r\n      return;\r\n    }\r\n\r\n    // remove the selected nodes\r\n    if (e.key === \"Delete\") {\r\n      [...this.selection].forEach((node) => {\r\n        const nodeObj = this.graph.getNodeById(node);\r\n        this.stack.exec(RemoveNodeCmd(this.graph, nodeObj));\r\n        this.graph.removeNode(node);\r\n      });\r\n\r\n      this.render();\r\n    }\r\n  }\r\n\r\n  _setCursor(c) {\r\n    if (this._cursor !== c) {\r\n      this._cursor = c;\r\n      this.renderer.canvas.style.cursor = c;\r\n    }\r\n  }\r\n\r\n  _posScreen(e) {\r\n    const r = this.renderer.canvas.getBoundingClientRect();\r\n    return { x: e.clientX - r.left, y: e.clientY - r.top };\r\n  }\r\n\r\n  _posWorld(e) {\r\n    const s = this._posScreen(e);\r\n    return this.renderer.screenToWorld(s.x, s.y);\r\n  }\r\n\r\n  _findNodeAtWorld(x, y) {\r\n    // Reverse order (top to bottom)\r\n    const list = [...this.graph.nodes.values()].reverse();\r\n    for (const n of list) {\r\n      // Use computed world transform for hit testing\r\n      const { x: nx, y: ny, w, h } = n.computed;\r\n      if (x >= nx && x <= nx + w && y >= ny && y <= ny + h) {\r\n        return n;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  _findPortAtWorld(x, y) {\r\n    for (const n of this.graph.nodes.values()) {\r\n      for (let i = 0; i < n.inputs.length; i++) {\r\n        const r = portRect(n, n.inputs[i], i, \"in\");\r\n        if (rectHas(r, x, y))\r\n          return { node: n, port: n.inputs[i], dir: \"in\", idx: i };\r\n      }\r\n      for (let i = 0; i < n.outputs.length; i++) {\r\n        const r = portRect(n, n.outputs[i], i, \"out\");\r\n        if (rectHas(r, x, y))\r\n          return { node: n, port: n.outputs[i], dir: \"out\", idx: i };\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  _findIncomingEdge(nodeId, portId) {\r\n    for (const [eid, e] of this.graph.edges) {\r\n      if (e.toNode === nodeId && e.toPort === portId) {\r\n        return { id: eid, edge: e };\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  _onWheel(e) {\r\n    e.preventDefault();\r\n    const { x, y } = this._posScreen(e);\r\n    const factor = Math.pow(1.0015, -e.deltaY); // smooth zoom\r\n    this.renderer.zoomAt(factor, x, y);\r\n    this.render();\r\n  }\r\n\r\n  _resizeHandleRect(node) {\r\n    const s = 10;\r\n    const { x, y, w, h } = node.computed;\r\n    return {\r\n      x: x + w - s,\r\n      y: y + h - s,\r\n      w: s,\r\n      h: s,\r\n    };\r\n  }\r\n\r\n  _hitResizeHandle(node, wx, wy) {\r\n    const r = this._resizeHandleRect(node);\r\n    return wx >= r.x && wx <= r.x + r.w && wy >= r.y && wy <= r.y + r.h;\r\n  }\r\n\r\n  _onDown(e) {\r\n    const s = this._posScreen(e);\r\n    const w = this._posWorld(e);\r\n\r\n    if (e.button === 1) {\r\n      this.panning = { x: s.x, y: s.y };\r\n      return;\r\n    }\r\n\r\n    // 1. Resize Handle Hit Test (for all nodes including groups)\r\n    const node = this._findNodeAtWorld(w.x, w.y);\r\n    if (e.button === 0 && node && this._hitResizeHandle(node, w.x, w.y)) {\r\n      this.resizing = {\r\n        nodeId: node.id,\r\n        startW: node.size.width,\r\n        startH: node.size.height,\r\n        startX: w.x,\r\n        startY: w.y,\r\n      };\r\n      if (!e.shiftKey) this.selection.clear();\r\n      this.selection.add(node.id);\r\n      this._setCursor(\"se-resize\");\r\n      this.render();\r\n      return;\r\n    }\r\n\r\n    // 2. Port Hit Test\r\n    const port = this._findPortAtWorld(w.x, w.y);\r\n    if (e.button === 0 && port && port.dir === \"out\") {\r\n      const outR = portRect(port.node, port.port, port.idx, \"out\");\r\n      const screenFrom = this.renderer.worldToScreen(outR.x, outR.y + 7);\r\n      this.connecting = {\r\n        fromNode: port.node.id,\r\n        fromPort: port.port.id,\r\n        x: screenFrom.x,\r\n        y: screenFrom.y,\r\n      };\r\n      return;\r\n    }\r\n\r\n    // 3. Node Hit Test (Selection & Drag)\r\n    if (e.button === 0 && node) {\r\n      if (!e.shiftKey) this.selection.clear();\r\n      this.selection.add(node.id);\r\n      \r\n      // Dragging: store initial world pos difference\r\n      // When moving, we calculate new world pos, then convert to local\r\n      this.dragging = {\r\n        nodeId: node.id,\r\n        offsetX: w.x - node.computed.x,\r\n        offsetY: w.y - node.computed.y,\r\n        startPos: { ...node.pos }, // for undo\r\n      };\r\n      this.render();\r\n      return;\r\n    }\r\n\r\n    // 4. Background Click (Pan)\r\n    if (e.button === 0) {\r\n      if (this.selection.size) this.selection.clear();\r\n      this.panning = { x: s.x, y: s.y };\r\n      this.render();\r\n      return;\r\n    }\r\n  }\r\n\r\n  _onMove(e) {\r\n    const s = this._posScreen(e);\r\n    const w = this.renderer.screenToWorld(s.x, s.y);\r\n\r\n    if (this.resizing) {\r\n      const n = this.graph.nodes.get(this.resizing.nodeId);\r\n      const dx = w.x - this.resizing.startX;\r\n      const dy = w.y - this.resizing.startY;\r\n\r\n      const minW = Controller.MIN_NODE_WIDTH;\r\n      const minH = Controller.MIN_NODE_HEIGHT;\r\n      n.size.width = Math.max(minW, this.resizing.startW + dx);\r\n      n.size.height = Math.max(minH, this.resizing.startH + dy);\r\n\r\n      this.hooks?.emit(\"node:resize\", n);\r\n      this._setCursor(\"se-resize\");\r\n      this.render();\r\n      return;\r\n    }\r\n\r\n    if (this.panning) {\r\n      const dx = s.x - this.panning.x;\r\n      const dy = s.y - this.panning.y;\r\n      this.panning = { x: s.x, y: s.y };\r\n      this.renderer.panBy(dx, dy);\r\n      this.render();\r\n      return;\r\n    }\r\n\r\n    if (this.dragging) {\r\n      const n = this.graph.nodes.get(this.dragging.nodeId);\r\n      \r\n      // Target World Pos\r\n      const targetWx = w.x - this.dragging.offsetX;\r\n      const targetWy = w.y - this.dragging.offsetY;\r\n\r\n      // Convert to Local Pos\r\n      // local = targetWorld - parentWorld\r\n      let parentWx = 0;\r\n      let parentWy = 0;\r\n      if (n.parent) {\r\n        parentWx = n.parent.computed.x;\r\n        parentWy = n.parent.computed.y;\r\n      }\r\n\r\n      n.pos.x = targetWx - parentWx;\r\n      n.pos.y = targetWy - parentWy;\r\n\r\n\r\n      this.hooks?.emit(\"node:move\", n);\r\n      this.render();\r\n      return;\r\n    }\r\n\r\n    if (this.connecting) {\r\n      this.connecting.x = s.x;\r\n      this.connecting.y = s.y;\r\n      this.render();\r\n    }\r\n\r\n    // Cursor update\r\n    const node = this._findNodeAtWorld(w.x, w.y);\r\n    if (node && this._hitResizeHandle(node, w.x, w.y)) {\r\n      this._setCursor(\"se-resize\");\r\n    } else {\r\n      this._setCursor(\"default\");\r\n    }\r\n  }\r\n\r\n  _onUp(e) {\r\n    const w = this._posWorld(e);\r\n\r\n    if (this.panning) {\r\n      this.panning = null;\r\n      return;\r\n    }\r\n\r\n    if (this.connecting) {\r\n      // ... (existing connection logic)\r\n      const from = this.connecting;\r\n      const portIn = this._findPortAtWorld(w.x, w.y);\r\n      if (portIn && portIn.dir === \"in\") {\r\n         this.stack.exec(\r\n          AddEdgeCmd(\r\n            this.graph,\r\n            from.fromNode,\r\n            from.fromPort,\r\n            portIn.node.id,\r\n            portIn.port.id\r\n          )\r\n        );\r\n      }\r\n      this.connecting = null;\r\n      this.render();\r\n    }\r\n\r\n    if (this.resizing) {\r\n      const n = this.graph.nodes.get(this.resizing.nodeId);\r\n      const from = { w: this.resizing.startW, h: this.resizing.startH };\r\n      const to = { w: n.size.width, h: n.size.height };\r\n      if (from.w !== to.w || from.h !== to.h) {\r\n        this.stack.exec(ResizeNodeCmd(n, from, to));\r\n      }\r\n      this.resizing = null;\r\n      this._setCursor(\"default\");\r\n    }\r\n\r\n    if (this.dragging) {\r\n      const n = this.graph.nodes.get(this.dragging.nodeId);\r\n      \r\n      // Reparenting Logic\r\n      // Check if dropped onto a group\r\n      // We need to find the group under the mouse, excluding the node itself and its children\r\n      const potentialParent = this._findPotentialParent(w.x, w.y, n);\r\n      \r\n      if (potentialParent && potentialParent !== n.parent) {\r\n        this.graph.reparent(n, potentialParent);\r\n      } else if (!potentialParent && n.parent) {\r\n        // Dropped on empty space -> move to root\r\n        this.graph.reparent(n, null);\r\n      }\r\n\r\n      this.dragging = null;\r\n      this.render();\r\n    }\r\n  }\r\n\r\n  _findPotentialParent(x, y, excludeNode) {\r\n    // Find top-most group under x,y that is not excludeNode or its descendants\r\n    const list = [...this.graph.nodes.values()].reverse();\r\n    for (const n of list) {\r\n      if (n.type !== \"core/Group\") continue;\r\n      if (n === excludeNode) continue;\r\n      // Check if n is descendant of excludeNode\r\n      let p = n.parent;\r\n      let isDescendant = false;\r\n      while(p) {\r\n        if (p === excludeNode) {\r\n          isDescendant = true;\r\n          break;\r\n        }\r\n        p = p.parent;\r\n      }\r\n      if (isDescendant) continue;\r\n\r\n      const { x: nx, y: ny, w, h } = n.computed;\r\n      if (x >= nx && x <= nx + w && y >= ny && y <= ny + h) {\r\n        return n;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  render() {\r\n    const tEdge = this.renderTempEdge();\r\n\r\n    this.renderer.draw(this.graph, {\r\n      selection: this.selection,\r\n      tempEdge: tEdge,\r\n    });\r\n    \r\n    this.htmlOverlay?.draw(this.graph, this.selection);\r\n  }\r\n\r\n  renderTempEdge() {\r\n    if (!this.connecting) return null;\r\n    const a = this._portAnchorScreen(\r\n      this.connecting.fromNode,\r\n      this.connecting.fromPort\r\n    ); // {x,y}\r\n    return {\r\n      x1: a.x,\r\n      y1: a.y,\r\n      x2: this.connecting.x,\r\n      y2: this.connecting.y,\r\n    };\r\n  }\r\n\r\n  _portAnchorScreen(nodeId, portId) {\r\n    const n = this.graph.nodes.get(nodeId);\r\n    const iOut = n.outputs.findIndex((p) => p.id === portId);\r\n    const r = portRect(n, null, iOut, \"out\"); // world rect\r\n    return this.renderer.worldToScreen(r.x, r.y + 7); // -> screen point\r\n  }\r\n}\r\n\r\nfunction rectHas(r, x, y) {\r\n  return x >= r.x && x <= r.x + r.w && y >= r.y && y <= r.y + r.h;\r\n}\r\n","export class Runner {\r\n  constructor({ graph, registry, hooks, cyclesPerFrame = 1 }) {\r\n    this.graph = graph;\r\n    this.registry = registry;\r\n    this.hooks = hooks;\r\n    this.running = false;\r\n    this._raf = null;\r\n    this._last = 0;\r\n    this.cyclesPerFrame = Math.max(1, cyclesPerFrame | 0);\r\n  }\r\n\r\n  // 외부에서 실행 중인지 확인\r\n  isRunning() {\r\n    return this.running;\r\n  }\r\n\r\n  // 실행 도중에도 CPS 변경 가능\r\n  setCyclesPerFrame(n) {\r\n    this.cyclesPerFrame = Math.max(1, n | 0);\r\n  }\r\n\r\n  step(cycles = 1, dt = 0) {\r\n    const nCycles = Math.max(1, cycles | 0);\r\n    for (let c = 0; c < nCycles; c++) {\r\n      for (const node of this.graph.nodes.values()) {\r\n        const def = this.registry.types.get(node.type);\r\n        if (def?.onExecute) {\r\n          try {\r\n            def.onExecute(node, {\r\n              dt,\r\n              graph: this.graph,\r\n              getInput: (portName) => {\r\n                const p =\r\n                  node.inputs.find((i) => i.name === portName) ||\r\n                  node.inputs[0];\r\n                return p ? this.graph.getInput(node.id, p.id) : undefined;\r\n              },\r\n              setOutput: (portName, value) => {\r\n                const p =\r\n                  node.outputs.find((o) => o.name === portName) ||\r\n                  node.outputs[0];\r\n                if (p) this.graph.setOutput(node.id, p.id, value);\r\n              },\r\n            });\r\n          } catch (err) {\r\n            this.hooks?.emit?.(\"error\", err);\r\n          }\r\n        }\r\n      }\r\n      // commit writes for this cycle\r\n      this.graph.swapBuffers();\r\n    }\r\n  }\r\n\r\n  start() {\r\n    if (this.running) return;\r\n    this.running = true;\r\n    this._last = 0;\r\n    this.hooks?.emit?.(\"runner:start\");\r\n\r\n    const loop = (t) => {\r\n      if (!this.running) return;\r\n      const dtMs = this._last ? t - this._last : 0;\r\n      this._last = t;\r\n      const dt = dtMs / 1000; // seconds\r\n\r\n      // 1) 스텝 실행\r\n      this.step(this.cyclesPerFrame, dt);\r\n\r\n      // 2) 프레임 훅 (렌더러/컨트롤러는 여기서 running, time, dt를 받아 표현 업데이트)\r\n      this.hooks?.emit?.(\"runner:tick\", {\r\n        time: t,\r\n        dt,\r\n        running: true,\r\n        cps: this.cyclesPerFrame,\r\n      });\r\n\r\n      this._raf = requestAnimationFrame(loop);\r\n    };\r\n\r\n    this._raf = requestAnimationFrame(loop);\r\n  }\r\n\r\n  stop() {\r\n    if (!this.running) return;\r\n    this.running = false;\r\n    if (this._raf) cancelAnimationFrame(this._raf);\r\n    this._raf = null;\r\n    this._last = 0;\r\n    this.hooks?.emit?.(\"runner:stop\");\r\n  }\r\n}\r\n","// 캔버스 위에 붙는 DOM 오버레이. 캔버스의 scale/offset에 맞춰 CSS transform을 적용.\r\n// 동기화 하기 까다로워서 아직 적용하지 않음\r\nexport class HtmlOverlay {\r\n  /**\r\n   * @param {HTMLElement} host  캔버스를 감싸는 래퍼( position: relative )\r\n   * @param {CanvasRenderer} renderer\r\n   * @param {Registry} registry\r\n   */\r\n  constructor(host, renderer, registry) {\r\n    this.host = host;\r\n    this.renderer = renderer;\r\n    this.registry = registry;\r\n    this.container = document.createElement(\"div\");\r\n    Object.assign(this.container.style, {\r\n      position: \"absolute\",\r\n      inset: \"0\",\r\n      pointerEvents: \"none\", // 기본은 통과\r\n      zIndex: \"10\",\r\n    });\r\n    host.appendChild(this.container);\r\n\r\n    /** @type {Map<string, HTMLElement>} */\r\n    this.nodes = new Map();\r\n  }\r\n\r\n  /** 기본 노드 레이아웃 생성 (헤더 + 바디) */\r\n  _createDefaultNodeLayout(node) {\r\n    const container = document.createElement(\"div\");\r\n    Object.assign(container.style, {\r\n      position: \"absolute\",\r\n      display: \"flex\",\r\n      flexDirection: \"column\",\r\n      boxSizing: \"border-box\",\r\n      pointerEvents: \"none\", // 기본은 통과 (캔버스 인터랙션 위해)\r\n      overflow: \"hidden\", // 둥근 모서리 등\r\n    });\r\n\r\n    const header = document.createElement(\"div\");\r\n    header.className = \"node-header\";\r\n    Object.assign(header.style, {\r\n      height: \"24px\",\r\n      flexShrink: \"0\",\r\n      display: \"flex\",\r\n      alignItems: \"center\",\r\n      padding: \"0 8px\",\r\n      cursor: \"grab\",\r\n      userSelect: \"none\",\r\n      pointerEvents: \"none\", // 헤더 클릭시 드래그는 캔버스가 처리\r\n    });\r\n\r\n    const body = document.createElement(\"div\");\r\n    body.className = \"node-body\";\r\n    Object.assign(body.style, {\r\n      flex: \"1\",\r\n      position: \"relative\",\r\n      overflow: \"hidden\",\r\n      pointerEvents: \"auto\", // 바디 내부는 인터랙션 가능하게? 아니면 이것도 none하고 자식만 auto?\r\n      // 일단 바디는 auto로 두면 바디 영역 클릭시 드래그가 안됨.\r\n      // 그래서 바디도 none으로 하고, 내부 컨텐츠(input 등)만 auto로 하는게 맞음.\r\n      pointerEvents: \"none\", \r\n    });\r\n\r\n    container.appendChild(header);\r\n    container.appendChild(body);\r\n\r\n    // 나중에 접근하기 쉽게 프로퍼티로 저장\r\n    container._domParts = { header, body };\r\n    return container;\r\n  }\r\n\r\n  /** 노드용 엘리먼트 생성(한 번만) */\r\n  _ensureNodeElement(node, def) {\r\n    let el = this.nodes.get(node.id);\r\n    if (!el) {\r\n      // 1) 사용자 정의 render 함수가 있으면 우선 사용\r\n      if (def.html?.render) {\r\n        el = def.html.render(node);\r\n      } \r\n      // 2) 아니면 기본 레이아웃 사용 (html 설정이 있는 경우)\r\n      else if (def.html) {\r\n        el = this._createDefaultNodeLayout(node);\r\n        // 초기화 훅\r\n        if (def.html.init) {\r\n          def.html.init(node, el, el._domParts);\r\n        }\r\n      } else {\r\n        return null; // HTML 없음\r\n      }\r\n\r\n      if (!el) return null;\r\n      \r\n      el.style.position = \"absolute\";\r\n      el.style.pointerEvents = \"none\"; // 기본적으로 캔버스 통과\r\n      this.container.appendChild(el);\r\n      this.nodes.set(node.id, el);\r\n    }\r\n    return el;\r\n  }\r\n\r\n  /** 그래프와 변환 동기화하여 렌더링 */\r\n  draw(graph, selection = new Set()) {\r\n    // 컨테이너 전체에 월드 변환 적용 (CSS 픽셀 기준)\r\n    const { scale, offsetX, offsetY } = this.renderer;\r\n    this.container.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;\r\n    this.container.style.transformOrigin = \"0 0\";\r\n\r\n    const seen = new Set();\r\n\r\n    for (const node of graph.nodes.values()) {\r\n      const def = this.registry.types.get(node.type);\r\n      \r\n      // render 함수가 있거나, html 설정 객체가 있으면 처리\r\n      const hasHtml = !!(def?.html);\r\n      if (!hasHtml) continue;\r\n\r\n      const el = this._ensureNodeElement(node, def);\r\n      if (!el) continue;\r\n\r\n      // 노드 위치/크기 동기화 (월드 좌표 → 컨테이너 내부는 이미 scale/translate 적용)\r\n      console.log(node)\r\n      el.style.left = `${node.computed.x}px`;\r\n      el.style.top = `${node.computed.y}px`;\r\n      el.style.width = `${node.computed.w}px`;\r\n      el.style.height = `${node.computed.h}px`;\r\n\r\n      // 선택 상태 등 업데이트 훅\r\n      if (def.html.update) {\r\n        // 기본 레이아웃이면 header/body도 함께 전달\r\n        const parts = el._domParts || {};\r\n        def.html.update(node, el, { \r\n          selected: selection.has(node.id),\r\n          header: parts.header,\r\n          body: parts.body\r\n        });\r\n      }\r\n\r\n      seen.add(node.id);\r\n    }\r\n\r\n    // 없어진 노드 제거\r\n    for (const [id, el] of this.nodes) {\r\n      if (!seen.has(id)) {\r\n        el.remove();\r\n        this.nodes.delete(id);\r\n      }\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const [, el] of this.nodes) el.remove();\r\n    this.nodes.clear();\r\n    this.container.remove();\r\n  }\r\n}\r\n","import { Registry } from \"./core/Registry.js\";\r\nimport { createHooks } from \"./core/Hooks.js\";\r\nimport { Graph } from \"./core/Graph.js\";\r\nimport { CanvasRenderer } from \"./render/CanvasRenderer.js\";\r\nimport { Controller } from \"./interact/Controller.js\";\r\nimport { Runner } from \"./core/Runner.js\";\r\n\r\nimport { HtmlOverlay } from \"./render/HtmlOverlay.js\";\r\n\r\nexport function createGraphEditor(\r\n  canvas,\r\n  { theme, hooks: customHooks, autorun = true } = {}\r\n) {\r\n  const hooks =\r\n    customHooks ??\r\n    createHooks([\r\n      // essential hooks\r\n      \"node:create\",\r\n      \"node:move\",\r\n      \"edge:create\",\r\n      \"edge:delete\",\r\n      \"graph:serialize\",\r\n      \"error\",\r\n      \"runner:tick\",\r\n      \"runner:start\",\r\n      \"runner:stop\",\r\n      \"node:resize\",\r\n      \"group:change\",\r\n      \"node:updated\",\r\n    ]);\r\n  const registry = new Registry();\r\n  const graph = new Graph({ hooks, registry });\r\n  const renderer = new CanvasRenderer(canvas, { theme, registry });\r\n  // HTML Overlay\r\n  const htmlOverlay = new HtmlOverlay(canvas.parentElement, renderer, registry);\r\n\r\n  const controller = new Controller({ graph, renderer, hooks, htmlOverlay });\r\n  const runner = new Runner({ graph, registry, hooks });\r\n\r\n  hooks.on(\"runner:tick\", ({ time, dt }) => {\r\n    renderer.draw(graph, {\r\n      selection: controller.selection,\r\n      tempEdge: controller.connecting ? controller.renderTempEdge() : null, // 필요시 helper\r\n      running: true,\r\n      time,\r\n      dt,\r\n    });\r\n    htmlOverlay.draw(graph, controller.selection);\r\n  });\r\n  hooks.on(\"runner:start\", () => {\r\n    // 첫 프레임 즉시 렌더\r\n    renderer.draw(graph, {\r\n      selection: controller.selection,\r\n      tempEdge: controller.connecting ? controller.renderTempEdge() : null,\r\n      running: true,\r\n      time: performance.now(),\r\n      dt: 0,\r\n    });\r\n    htmlOverlay.draw(graph, controller.selection);\r\n  });\r\n  hooks.on(\"runner:stop\", () => {\r\n    // 정지 프레임\r\n    renderer.draw(graph, {\r\n      selection: controller.selection,\r\n      tempEdge: controller.connecting ? controller.renderTempEdge() : null,\r\n      running: false,\r\n      time: performance.now(),\r\n      dt: 0,\r\n    });\r\n    htmlOverlay.draw(graph, controller.selection);\r\n  });\r\n\r\n  hooks.on(\"node:updated\", () => {\r\n    controller.render();\r\n  });\r\n\r\n  // default node\r\n  registry.register(\"core/Note\", {\r\n    title: \"Note\",\r\n    size: { w: 180, h: 80 },\r\n    inputs: [{ name: \"in\", datatype: \"any\" }],\r\n    outputs: [{ name: \"out\", datatype: \"any\" }],\r\n    onCreate(node) {\r\n      node.state.text = \"hello\";\r\n    },\r\n    onExecute(node, { dt, getInput, setOutput }) {\r\n      // Simple passthrough with uppercase and a heartbeat value\r\n      const incoming = getInput(\"in\");\r\n      const out = (incoming ?? node.state.text ?? \"\").toString().toUpperCase();\r\n      setOutput(\r\n        \"out\",\r\n        out + ` · ${Math.floor((performance.now() / 1000) % 100)}`\r\n      );\r\n    },\r\n    onDraw(node, { ctx, theme }) {\r\n      const pr = 8;\r\n      const { x, y } = node.pos;\r\n      const { width: w } = node.size;\r\n      const lx = x + pr; // 월드 x\r\n      const ly = y + 24 + 6; // 타이틀 바(24) 아래 여백 6\r\n      // renderer._drawScreenText(node.state.text ?? \"hello\", lx, ly, {\r\n      //   fontPx: 11,\r\n      //   color: theme.text,\r\n      //   baseline: \"top\",\r\n      //   align: \"left\",\r\n      // });\r\n    },\r\n  });\r\n\r\n  // HTML Custom Node Example\r\n  registry.register(\"core/HtmlNote\", {\r\n    title: \"HTML Note\",\r\n    size: { w: 200, h: 150 },\r\n    inputs: [{ name: \"in\", datatype: \"any\" }],\r\n    outputs: [{ name: \"out\", datatype: \"any\" }],\r\n    \r\n    // HTML Overlay Configuration\r\n    html: {\r\n      // 초기화: 헤더/바디 구성\r\n      init(node, el, { header, body }) {\r\n        el.style.backgroundColor = \"#222\";\r\n        el.style.borderRadius = \"8px\";\r\n        el.style.border = \"1px solid #444\";\r\n        el.style.boxShadow = \"0 4px 12px rgba(0,0,0,0.3)\";\r\n\r\n        // Header\r\n        header.style.backgroundColor = \"#333\";\r\n        header.style.borderBottom = \"1px solid #444\";\r\n        header.style.color = \"#eee\";\r\n        header.style.fontSize = \"12px\";\r\n        header.style.fontWeight = \"bold\";\r\n        header.textContent = \"My HTML Node\";\r\n\r\n        // Body\r\n        body.style.padding = \"8px\";\r\n        body.style.color = \"#ccc\";\r\n        body.style.fontSize = \"12px\";\r\n\r\n        const contentDiv = document.createElement(\"div\");\r\n        contentDiv.textContent = \"Content: -- 인션이\";\r\n        body.appendChild(contentDiv);\r\n        \r\n        // Add some interactive content\r\n        const input = document.createElement(\"input\");\r\n        Object.assign(input.style, {\r\n          marginTop: \"4px\",\r\n          padding: \"4px\",\r\n          background: \"#111\",\r\n          border: \"1px solid #555\",\r\n          color: \"#fff\",\r\n          borderRadius: \"4px\",\r\n          pointerEvents: \"auto\",\r\n        });\r\n        input.placeholder = \"Type here...\";\r\n        input.addEventListener(\"input\", (e) => {\r\n          node.state.text = e.target.value;\r\n        });\r\n        input.addEventListener(\"mousedown\", (e) => e.stopPropagation()); // 캔버스 드래그 방지\r\n        \r\n        body.appendChild(document.createTextNode(\"Content:\"));\r\n        body.appendChild(input);\r\n        \r\n        // Store input ref for updates\r\n        el._input = input;\r\n      },\r\n      \r\n      // 매 프레임(또는 필요시) 업데이트\r\n      update(node, el, { header, body, selected }) {\r\n        el.style.borderColor = selected ? \"#6cf\" : \"#444\";\r\n        header.style.backgroundColor = selected ? \"#3a4a5a\" : \"#333\";\r\n        \r\n        // 상태 동기화 (외부에서 변경되었을 경우)\r\n        if (el._input.value !== (node.state.text || \"\")) {\r\n          el._input.value = node.state.text || \"\";\r\n        }\r\n      }\r\n    },\r\n\r\n    onCreate(node) {\r\n      node.state.text = \"\";\r\n    },\r\n    onExecute(node, { getInput, setOutput }) {\r\n      const incoming = getInput(\"in\");\r\n      setOutput(\"out\", incoming);\r\n    },\r\n    // onDraw는 생략 가능 (HTML이 덮으니까)\r\n    // 하지만 포트 등은 그려야 할 수도 있음. \r\n    // 현재 구조상 CanvasRenderer가 기본 노드를 그리므로, \r\n    // 투명하게 하거나 겹쳐서 그릴 수 있음.\r\n  });\r\n\r\n  // Todo List Node Example (HTML Overlay)\r\n  registry.register(\"core/TodoNode\", {\r\n    title: \"Todo List\",\r\n    size: { w: 240, h: 300 },\r\n    inputs: [{ name: \"in\", datatype: \"any\" }],\r\n    outputs: [{ name: \"out\", datatype: \"any\" }],\r\n    html: {\r\n      init(node, el, { header, body }) {\r\n        el.style.backgroundColor = \"#1e1e24\";\r\n        el.style.borderRadius = \"8px\";\r\n        el.style.boxShadow = \"0 4px 12px rgba(0,0,0,0.5)\";\r\n        el.style.border = \"1px solid #333\";\r\n\r\n        header.style.backgroundColor = \"#2a2a31\";\r\n        header.style.padding = \"8px\";\r\n        header.style.fontWeight = \"bold\";\r\n        header.style.color = \"#e9e9ef\";\r\n        header.textContent = node.title;\r\n\r\n        body.style.display = \"flex\";\r\n        body.style.flexDirection = \"column\";\r\n        body.style.padding = \"8px\";\r\n        body.style.color = \"#e9e9ef\";\r\n\r\n        // Input Area\r\n        const inputRow = document.createElement(\"div\");\r\n        Object.assign(inputRow.style, { display: \"flex\", gap: \"4px\", marginBottom: \"8px\" });\r\n        \r\n        const input = document.createElement(\"input\");\r\n        Object.assign(input.style, {\r\n          flex: \"1\", padding: \"6px\", borderRadius: \"4px\", \r\n          border: \"1px solid #444\", background: \"#141417\", color: \"#fff\",\r\n          pointerEvents: \"auto\",\r\n        });\r\n        input.placeholder = \"Add task...\";\r\n        \r\n        const addBtn = document.createElement(\"button\");\r\n        addBtn.textContent = \"+\";\r\n        Object.assign(addBtn.style, {\r\n          padding: \"0 12px\", cursor: \"pointer\", background: \"#4f5b66\", \r\n          color: \"#fff\", border: \"none\", borderRadius: \"4px\",\r\n          pointerEvents: \"auto\",\r\n        });\r\n\r\n        inputRow.append(input, addBtn);\r\n\r\n        // List Area\r\n        const list = document.createElement(\"ul\");\r\n        Object.assign(list.style, {\r\n          listStyle: \"none\", padding: \"0\", margin: \"0\", \r\n          overflowY: \"auto\", flex: \"1\"\r\n        });\r\n\r\n        body.append(inputRow, list);\r\n\r\n        // Logic\r\n        const addTodo = () => {\r\n          const text = input.value.trim();\r\n          if (!text) return;\r\n          const todos = node.state.todos || [];\r\n          node.state.todos = [...todos, { id: Date.now(), text, done: false }];\r\n          input.value = \"\";\r\n          hooks.emit(\"node:updated\", node);\r\n        };\r\n\r\n        addBtn.onclick = addTodo;\r\n        input.onkeydown = (e) => {\r\n          if (e.key === \"Enter\") addTodo();\r\n          e.stopPropagation();\r\n        };\r\n        input.onmousedown = (e) => e.stopPropagation(); // prevent drag\r\n\r\n        el._refs = { list };\r\n      },\r\n      update(node, el, { selected }) {\r\n        el.style.borderColor = selected ? \"#6cf\" : \"#333\";\r\n        \r\n        const { list } = el._refs;\r\n        const todos = node.state.todos || [];\r\n\r\n        // Re-render list (simple approach)\r\n        list.innerHTML = \"\";\r\n        todos.forEach((todo) => {\r\n          const li = document.createElement(\"li\");\r\n          Object.assign(li.style, {\r\n            display: \"flex\", alignItems: \"center\", padding: \"6px 0\", \r\n            borderBottom: \"1px solid #2a2a31\"\r\n          });\r\n\r\n          const chk = document.createElement(\"input\");\r\n          chk.type = \"checkbox\";\r\n          chk.checked = todo.done;\r\n          chk.style.marginRight = \"8px\";\r\n          chk.style.pointerEvents = \"auto\";\r\n          chk.onchange = () => { \r\n            todo.done = chk.checked;\r\n            hooks.emit(\"node:updated\", node);\r\n          };\r\n          chk.onmousedown = (e) => e.stopPropagation();\r\n\r\n          const span = document.createElement(\"span\");\r\n          span.textContent = todo.text;\r\n          span.style.flex = \"1\";\r\n          span.style.textDecoration = todo.done ? \"line-through\" : \"none\";\r\n          span.style.color = todo.done ? \"#777\" : \"#eee\";\r\n\r\n          const del = document.createElement(\"button\");\r\n          del.textContent = \"×\";\r\n          Object.assign(del.style, {\r\n            background: \"none\", border: \"none\", color: \"#f44\", \r\n            cursor: \"pointer\", fontSize: \"16px\",\r\n            pointerEvents: \"auto\",\r\n          });\r\n          del.onclick = () => {\r\n            node.state.todos = node.state.todos.filter((t) => t.id !== todo.id);\r\n            hooks.emit(\"node:updated\", node);\r\n          };\r\n          del.onmousedown = (e) => e.stopPropagation();\r\n\r\n          li.append(chk, span, del);\r\n          list.appendChild(li);\r\n        });\r\n      }\r\n    },\r\n    onCreate(node) {\r\n      node.state.todos = [\r\n        { id: 1, text: \"Welcome to Free Node\", done: false },\r\n        { id: 2, text: \"Try adding a task\", done: true },\r\n      ];\r\n    },\r\n  });\r\n\r\n  // Group Node\r\n  registry.register(\"core/Group\", {\r\n    title: \"Group\",\r\n    size: { w: 240, h: 160 },\r\n    onDraw(node, { ctx, theme }) {\r\n      const { x, y, w, h } = node.computed;\r\n      const headerH = 22;\r\n      const color = node.state.color || \"#39424e\";\r\n      const bgAlpha = 0.5;\r\n      const textColor = theme.text || \"#e9e9ef\";\r\n\r\n      // Helper for rgba\r\n      const rgba = (hex, a) => {\r\n        const c = hex.replace(\"#\", \"\");\r\n        const n = parseInt(\r\n          c.length === 3\r\n            ? c\r\n                .split(\"\")\r\n                .map((x) => x + x)\r\n                .join(\"\")\r\n            : c,\r\n          16\r\n        );\r\n        const r = (n >> 16) & 255,\r\n          g = (n >> 8) & 255,\r\n          b = n & 255;\r\n        return `rgba(${r},${g},${b},${a})`;\r\n      };\r\n\r\n      // Helper for roundRect\r\n      const roundRect = (ctx, x, y, w, h, r) => {\r\n        if (w < 2 * r) r = w / 2;\r\n        if (h < 2 * r) r = h / 2;\r\n        ctx.beginPath();\r\n        ctx.moveTo(x + r, y);\r\n        ctx.arcTo(x + w, y, x + w, y + h, r);\r\n        ctx.arcTo(x + w, y + h, x, y + h, r);\r\n        ctx.arcTo(x, y + h, x, y, r);\r\n        ctx.arcTo(x, y, x + w, y, r);\r\n        ctx.closePath();\r\n      };\r\n\r\n      // Body\r\n      ctx.fillStyle = rgba(color, bgAlpha);\r\n      roundRect(ctx, x, y, w, h, 10);\r\n      ctx.fill();\r\n\r\n      // Header\r\n      ctx.fillStyle = color;\r\n      ctx.beginPath();\r\n      ctx.roundRect(x, y, w, headerH + 6, [10, 10, 0, 0]);\r\n      ctx.fill();\r\n\r\n      // Title\r\n      ctx.fillStyle = textColor;\r\n      ctx.font = \"12px system-ui\";\r\n      ctx.textBaseline = \"middle\";\r\n      ctx.fillText(node.title, x + 10, y + headerH / 2);\r\n    },\r\n  });\r\n\r\n\r\n  // initial render & resize\r\n\r\n  renderer.resize(canvas.clientWidth, canvas.clientHeight);\r\n  controller.render();\r\n\r\n  const ro = new ResizeObserver(() => {\r\n    renderer.resize(canvas.clientWidth, canvas.clientHeight);\r\n    controller.render();\r\n  });\r\n  ro.observe(canvas);\r\n\r\n  const api = {\r\n    addGroup: (args = {}) => {\r\n      controller.graph.groupManager.addGroup(args);\r\n      controller.render();\r\n    },\r\n    graph,\r\n    renderer,\r\n    render: () => controller.render(),\r\n    start: () => runner.start(),\r\n    stop: () => runner.stop(),\r\n    destroy: () => {\r\n      runner.stop();\r\n      ro.disconnect();\r\n      controller.destructor();\r\n      htmlOverlay.destroy();\r\n    },\r\n  };\r\n\r\n  if (autorun) runner.start();\r\n  return api;\r\n}\r\n","export function createHooks(names) {\r\n  const map = Object.fromEntries(names.map((n) => [n, new Set()]));\r\n  return {\r\n    on(name, fn) {\r\n      map[name].add(fn);\r\n      return () => map[name].delete(fn);\r\n    },\r\n    async emit(name, ...args) {\r\n      for (const fn of map[name]) await fn(...args);\r\n    },\r\n  };\r\n}\r\n"],"names":["Registry","constructor","this","types","Map","register","type","def","Error","has","set","unregister","delete","removeAll","clear","createInstance","get","available","Array","from","keys","join","randomUUID","g","globalThis","self","window","global","c","crypto","msCrypto","getRandomValues","bytes","Uint8Array","hex","b","toString","padStart","slice","req","Function","nodeCrypto","randomBytes","i","Math","floor","random","Node","id","title","x","y","width","height","pos","size","inputs","outputs","state","parent","children","Set","computed","w","h","addInput","name","datatype","port","dir","push","addOutput","Edge","fromNode","fromPort","toNode","toPort","GroupManager","graph","hooks","addGroup","color","members","console","warn","max","groupNode","addNode","memberId","node","getNodeById","reparent","_a","emit","addGroupFromSelection","margin","removeGroup","child","removeNode","resizeGroup","dw","dh","updateWorldTransforms","hitTestResizeHandle","nodes","values","reverse","gx","gy","gw","gh","group","handle","Graph","registry","edges","_valuesA","_valuesB","_useAasCurrent","groupManager","opts","_b","o","_c","onCreate","call","_d","nodeId","eid","e","addEdge","roots","n","stack","map","px","py","length","pop","newParent","wx","wy","add","_curBuf","_nextBuf","swapBuffers","setOutput","portId","value","getInput","toJSON","json","fromJSON","nd","ed","portRect","idx","nx","ny","_CanvasRenderer","canvas","theme","edgeStyle","ctx","getContext","scale","minScale","maxScale","offsetX","offsetY","Object","assign","bg","grid","text","edge","setEdgeStyle","style","setRegistry","reg","resize","setTransform","min","panBy","dx","dy","zoomAt","factor","cx","cy","prev","next","screenToWorld","worldToScreen","_applyTransform","_resetTransform","_drawArrowhead","x1","y1","x2","y2","s","ang","atan2","beginPath","moveTo","lineTo","cos","PI","sin","closePath","fill","_drawScreenText","lx","ly","fontPx","align","baseline","dpr","sx","sy","save","round","font","fillStyle","textAlign","textBaseline","fillText","restore","drawGrid","fillRect","strokeStyle","lineWidth","step","x0","y0","startX","startY","stroke","draw","selection","tempEdge","running","time","performance","now","dt","groups","phase","FONT_SIZE","setLineDash","lineDashOffset","sel","onDraw","_drawNode","_drawEdge","a","prevDash","getLineDash","ptsForArrow","_drawLine","_drawOrthogonal","_drawCurve","p1","p2","_rgba","replace","parseInt","split","selected","roundRect","tl","tr","br","bl","forEach","p","rct","to","iOut","findIndex","iIn","pr1","pr2","_drawPolyline","points","midX","pts","prevJoin","lineJoin","prevCap","lineCap","abs","bezierCurveTo","__publicField","CanvasRenderer","r","quadraticCurveTo","findEdgeId","d","CommandStack","undoStack","redoStack","exec","cmd","do","undo","redo","_Controller","renderer","htmlOverlay","dragging","connecting","panning","resizing","gDragging","gResizing","_cursor","_onKeyPressEvt","_onKeyPress","bind","_onDownEvt","_onDown","_onWheelEvt","_onWheel","_onMoveEvt","_onMove","_onUpEvt","_onUp","_bindEvents","destructor","removeEventListener","passive","addEventListener","ctrlKey","metaKey","key","toLowerCase","preventDefault","shiftKey","render","nodeObj","removedNode","removedEdges","filter","log","RemoveNodeCmd","_setCursor","cursor","_posScreen","getBoundingClientRect","clientX","left","clientY","top","_posWorld","_findNodeAtWorld","list","_findPortAtWorld","rectHas","_findIncomingEdge","pow","deltaY","_resizeHandleRect","_hitResizeHandle","button","startW","startH","outR","screenFrom","startPos","minW","MIN_NODE_WIDTH","minH","MIN_NODE_HEIGHT","targetWx","targetWy","parentWx","parentWy","portIn","addedId","AddEdgeCmd","fromSize","toSize","potentialParent","_findPotentialParent","excludeNode","isDescendant","tEdge","renderTempEdge","_portAnchorScreen","Controller","Runner","cyclesPerFrame","_raf","_last","isRunning","setCyclesPerFrame","cycles","nCycles","onExecute","portName","find","err","start","loop","t","dtMs","cps","requestAnimationFrame","stop","cancelAnimationFrame","HtmlOverlay","host","container","document","createElement","position","inset","pointerEvents","zIndex","appendChild","_createDefaultNodeLayout","display","flexDirection","boxSizing","overflow","header","className","flexShrink","alignItems","padding","userSelect","body","flex","_domParts","_ensureNodeElement","el","html","init","transform","transformOrigin","seen","update","parts","remove","destroy","customHooks","autorun","names","fromEntries","on","fn","args","createHooks","parentElement","controller","runner","toUpperCase","backgroundColor","borderRadius","border","boxShadow","borderBottom","fontSize","fontWeight","textContent","contentDiv","input","marginTop","background","placeholder","target","stopPropagation","createTextNode","_input","borderColor","inputRow","gap","marginBottom","addBtn","append","listStyle","overflowY","addTodo","trim","todos","Date","done","onclick","onkeydown","onmousedown","_refs","innerHTML","todo","li","chk","checked","marginRight","onchange","span","textDecoration","del","textColor","rgba","arcTo","headerH","clientWidth","clientHeight","ro","ResizeObserver","observe","api","disconnect"],"mappings":"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"}