<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Graph Editor Demo (with Runner)</title>
  <link rel="stylesheet" href="./src/ui/PropertyPanel.css" />
  <link rel="stylesheet" href="./index.css" />
</head>

<body>
  <div id="wrap">
    <main class="content-root" id="graph-editor">
      <div id="toolbar">
        <button id="saveBtn" title="Save graph to file (JSON)">
          üíæ Save
        </button>

        <button id="loadBtn" title="Load graph from file">
          üìÅ Load
        </button>

        <div style="width: 1px; height: 24px; background: #444; margin: 0 8px;"></div>

        <label>
          <span>Edge Style:</span>
          <select id="edgeStyleSelector">
            <option value="bezier">Curved</option>
            <option value="orthogonal" selected>Orthogonal</option>
            <option value="line">Straight</option>
          </select>
        </label>

        <div class="indicator" id="snapIndicator">
          Snap: ON
        </div>
      </div>

      <div id="helpToggle" title="Toggle shortcuts help (? key)">?</div>

      <div id="helpOverlay">
        <h3>
          <span>‚å®Ô∏è Keyboard Shortcuts</span>
          <button class="close-btn" id="helpClose" title="Close (Esc)">√ó</button>
        </h3>

        <h4>üéØ Selection</h4>
        <div class="shortcut-item">
          <span>Select Node</span>
          <span class="shortcut-key">Click</span>
        </div>
        <div class="shortcut-item">
          <span>Add to Selection</span>
          <span class="shortcut-key">Shift + Click</span>
        </div>
        <div class="shortcut-item">
          <span>Box Select</span>
          <span class="shortcut-key">Ctrl + Drag</span>
        </div>

        <h4>‚úÇÔ∏è Editing</h4>
        <div class="shortcut-item">
          <span>Delete Selected</span>
          <span class="shortcut-key">Delete</span>
        </div>
        <div class="shortcut-item">
          <span>Undo</span>
          <span class="shortcut-key">Ctrl + Z</span>
        </div>
        <div class="shortcut-item">
          <span>Redo</span>
          <span class="shortcut-key">Ctrl + Y</span>
        </div>

        <h4>üì¶ Grouping</h4>
        <div class="shortcut-item">
          <span>Create Group</span>
          <span class="shortcut-key">Ctrl + G</span>
        </div>

        <h4>üìê Alignment</h4>
        <div class="shortcut-item">
          <span>Align Horizontal</span>
          <span class="shortcut-key">A</span>
        </div>
        <div class="shortcut-item">
          <span>Align Vertical</span>
          <span class="shortcut-key">Shift + A</span>
        </div>

        <h4>üîß Tools</h4>
        <div class="shortcut-item">
          <span>Toggle Snap-to-Grid</span>
          <span class="shortcut-key">G</span>
        </div>
        <div class="shortcut-item">
          <span>Pan Canvas</span>
          <span class="shortcut-key">Middle Click + Drag</span>
        </div>
        <div class="shortcut-item">
          <span>Zoom</span>
          <span class="shortcut-key">Mouse Wheel</span>
        </div>
        <div class="shortcut-item">
          <span>Context Menu</span>
          <span class="shortcut-key">Right Click</span>
        </div>
      </div>
    </main>
  </div>
  <script type="module">
    import { createGraphEditor } from "./src/index.js";

    // One-liner Initialization!
    const editor = createGraphEditor("#graph-editor", {
      theme: 'dark',
      autorun: false,
      showMinimap: true,
      enablePropertyPanel: true
    });

    // Edge style selector
    const edgeStyleSelector = document.getElementById("edgeStyleSelector");
    edgeStyleSelector.addEventListener("change", (e) => {
      editor.renderer.setEdgeStyle(e.target.value);
      editor.render();
    });

    // Update snap indicator
    const snapIndicator = document.getElementById("snapIndicator");

    // Help overlay toggle
    const helpOverlay = document.getElementById("helpOverlay");
    const helpToggle = document.getElementById("helpToggle");

    if (helpToggle && helpOverlay) {
      helpToggle.addEventListener('click', () => {
        helpOverlay.classList.toggle('visible');
        helpToggle.classList.toggle('active');
      });

      // Close button
      const helpClose = document.getElementById('helpClose');
      if (helpClose) {
        helpClose.addEventListener('click', (e) => {
          e.stopPropagation();
          helpOverlay.classList.remove('visible');
          helpToggle.classList.remove('active');
        });
      }
    }

    // Toggle with ? key and ESC to close
    window.addEventListener('keydown', (e) => {
      if (helpOverlay && helpToggle) {
        if (e.key === '?' || (e.shiftKey && e.key === '/')) {
          e.preventDefault();
          helpOverlay.classList.toggle('visible');
          helpToggle.classList.toggle('active');
        }

        // ESC to close help
        if (e.key === 'Escape' && helpOverlay.classList.contains('visible')) {
          helpOverlay.classList.remove('visible');
          helpToggle.classList.remove('active');
        }
      }

      // Update snap indicator when G is pressed
      if (e.key.toLowerCase() === 'g' && !e.ctrlKey && !e.metaKey && editor.controller) {
        setTimeout(() => {
          snapIndicator.textContent = `Snap: ${editor.controller.snapToGrid ? "ON" : "OFF"}`;
          snapIndicator.classList.toggle("active", editor.controller.snapToGrid);
        }, 10);
      }
    });

    // Wrap editor.render to update snap indicator
    const originalRender = editor.render.bind(editor);
    editor.render = function () {
      originalRender();

      // Update snap indicator
      if (editor.controller) {
        snapIndicator.textContent = `Snap: ${editor.controller.snapToGrid ? "ON" : "OFF"}`;
        snapIndicator.classList.toggle("active", editor.controller.snapToGrid);
      }
    };

    // Initial render
    editor.render();

    // Create example node flow
    async function createExampleFlow() {
      const response = await fetch(import.meta.env.BASE_URL + "example.json");
      const jsonData = await response.json();
      editor.graph.clear();
      editor.graph.fromJSON(jsonData);

      // Clear HTML overlay to force re-initialization with new state values
      if (editor.htmlOverlay) {
        editor.htmlOverlay.clear();
      }

      // Re-initialize Trigger nodes after loading (restore runner/controller refs)
      for (const node of editor.graph.nodes.values()) {
        if (node.type === "util/Trigger") {
          node.__runnerRef = editor.runner;
          node.__controllerRef = editor.controller;
        }
      }

      editor.render();
    }

    // Create example flow on startup
    createExampleFlow();

    // Start runner so the flow executes
    // editor.start();



    // Save/Load functionality
    document.getElementById("saveBtn")?.addEventListener("click", () => {
      let saved = editor.graph.toJSON();
      const mime = "application/json";
      const blob = new Blob([JSON.stringify(saved, null, 2)], {
        type: mime,
      });

      const url = changeFileToUrl(blob);
      const fileName = "graph";

      // Download element
      const downloadLink = document.createElement("a");
      downloadLink.href = url;
      downloadLink.download = `${fileName}.json`;

      // Download
      document.body.appendChild(downloadLink);
      downloadLink.click();

      // Cleanup
      document.body.removeChild(downloadLink);
      revokeURL(url);
    });

    document.getElementById("loadBtn")?.addEventListener("click", () => {
      const changeEvt = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();

          reader.onload = async (e) => {
            try {
              // Clear and load
              editor.graph.clear();
              const jsonData = JSON.parse(e.target.result);
              editor.graph.fromJSON(jsonData);
              editor.render();

              // Cleanup
              input.removeEventListener("change", changeEvt);
            } catch (error) {
              console.error(error);
              alert("Failed to load file. Please check the file format.");
            }
          };

          // Read file as text
          reader.readAsText(file);
        }
      };
      const input = document.createElement("input");
      input.accept = ".json";
      input.type = "file";
      input.multiple = false;
      input.click();
      input.addEventListener("change", changeEvt);
    });

    function revokeURL(objectUrl) {
      try {
        if (window.URL) {
          window.URL.revokeObjectURL(objectUrl);
        } else if (window.webkitURL) {
          window.webkitURL.revokeObjectURL(objectUrl);
        }
      } catch (error) {
        console.error(error);
      }
    }

    function changeFileToUrl(file) {
      // Î∂ÄÏ∞®Ï†ÅÏù∏ Î∞©Î≤ï
      if (window.URL) {
        return window.URL.createObjectURL(file);
      } else if (window.webkitURL) {
        return window.webkitURL.createObjectURL(file);
      } else {
        return null;
      }
    }
  </script>
</body>

</html>